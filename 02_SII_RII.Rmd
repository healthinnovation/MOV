---
title: "Untitled"
output: html_document
---

```{r, warning=F, message=F,comment=F}

library(tidyverse, warn.conflicts = F)
library(survey)
library(jtools)
library(sandwich)
library(sf)
library(extrafont)
library(patchwork)
library(cowplot)

region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")
```

# BASES

```{r}
# Base de trabajo
MOV_GENERAL <- read.csv("./BD.INTERMEDIAS/mov_general.csv")

df2<-MOV_GENERAL %>% 
  
  filter((CRED == "Si" | SEGURO == "Si")) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data, 
      .f = ~svydesign(id =~ V001, strata =~ V022, probs=~V005, data=.x))) 

options(survey.lonely.psu="remove")

```

# EVENTO: GENERAL

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x)),
    
    
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  ) 


# SII y RII por año (2010 - 2020)

  ssi.edu<-
    df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
   geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
 
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )
  
  #ggsave("SII_RII_education.png",width = 18, height = 5)

#########


temp<-df3 %>% 
  select(ANIO,hr) %>% 
  unnest(cols = c(hr)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
  geom_col(fill = "#AA5674")+
  geom_point()+
  geom_smooth(method = "lm",se = F)+
    xlab("Maternal education") +
    ylab("Rate")+
    scale_x_discrete(labels = c("NE","PS","HS","SE"))+
    theme(
    axis.title = element_text(face ="bold", size = 8),
    legend.text = element_text(size = 9, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 8)) +
  facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("cols_slope_education.png", width = 13, height = 9)

```


```{r}

```

## INDICE RIQUEZA

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x)),
    
    
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  ) 


# SII y RII por año (2010 - 2020)

ssi.ir<-
  df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

#ggsave("SII_RII_RIQ.png",width = 18, height = 5)


#######

temp<-df3 %>% 
  select(ANIO,hr) %>% 
  unnest(cols = c(hr)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
  geom_col(fill = "#AA5674")+
  geom_point()+
  geom_smooth(method = "lm",se = F)+
    xlab("Poverty quintile") +
    ylab("Rate")+
    scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
    theme(
    axis.title = element_text(face ="bold", size = 8),
    legend.text = element_text(size = 9, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 8)) +
  facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("cols_slope_RIQ.png", width = 13, height = 9)


```


```{r}
legend <- get_legend(ssi.edu)
ssi.edu<- ssi.edu + theme(legend.position = "none")
ssi.ir<- ssi.ir + theme(legend.position = "none")

grafico3<-plot_grid(ssi.edu,ssi.ir,  labels = c("A","B"), nrow = 1)

cowplot::plot_grid(grafico3,legend, ncol = 1, rel_heights = c(1,0.1))

ggsave("Fig4.png", width = 12, height = 6)
```


## EVENTO POR REGION


```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(DEPARTAMEN,INDICERIQUEZA,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    neumo = map(.x =df,
               .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                        orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                 
                 select(-MOV_NEUMO_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("INDICERIQUEZA") %>%
                     
                     mutate(
                       INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                 
                 select(DEPARTAMEN,INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    rota = map(.x =df,
               .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                        orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                 
                 select(-MOV_ROTA_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("INDICERIQUEZA") %>%
                     
                     mutate(
                       INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                 
                 select(DEPARTAMEN,INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
              .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_INFLU_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(DEPARTAMEN,INDICERIQUEZA,total,orden,vacuna,vacunatipo,se,-`SE`))
    
  ) %>% 
  
  
  mutate(
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop.map(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii_map(.x))
    
  )

################

df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  pivot_longer(cols = c(rii,sii), names_to = "index") %>% 
  
  mutate(
    line = ifelse(index=="rii",1,0)
  ) %>% 
  
  filter(index == "sii") %>% 
  
   ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo), size  = 1) +
  #geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  geom_hline(aes(yintercept = line), linetype = "dashed") +
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  facet_wrap(~index, scales = "free", labeller = labeller(index = c("rii" = "RII",
                                                                    "ssi" = "SII"))) +
    xlab("Years")+
    ylab("Value")+
    #theme_minimal()+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Candara"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold")
  ) + 
  
  facet_wrap(~DEPARTAMEN, scales = "free")

ggsave("Fig5.png", width = 25, height = 14)

##################

# df3 %>% select(ANIO,ssirii) %>% 
#   unnest(cols = c(ssirii)) %>% 
#   as.data.frame() %>% 
#   ungroup() %>% 
#   
#   pivot_longer(cols = c(rii,sii), names_to = "index") %>% 
#   
#   mutate(
#     line = ifelse(index=="rii",1,0)
#   ) %>% 
#   
#   filter(index == "sii") %>% 
#   
#    ggplot() +
#   geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo), size  = 1) +
#   geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   geom_hline(aes(yintercept = line), linetype = "dashed") +
#   
#   scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
#   facet_wrap(~index, scales = "free", labeller = labeller(index = c("rii" = "RII",
#                                                                     "ssi" = "SII"))) +
#     xlab("Years")+
#     ylab("Value")+
#     #theme_minimal()+
#     theme(
#     axis.title = element_text(face ="bold", size = 11),
#     legend.text = element_text(size = 8, face = "bold"),
#     axis.text = element_text(face = "bold", family = "Candara"),
#     axis.text.x = element_text( size = 9),
#     legend.position = "top",
#     legend.title = element_blank(),
#     axis.line = element_line(colour = "black", size = 1),
#     panel.background = element_blank(),
#     strip.background = element_blank(),
#     strip.text = element_text(face = "bold")
#   ) +
#   
#   facet_wrap(~DEPARTAMEN, scales = "free")

#ggsave("test.png", width = 22, height = 11)


#####################
  
df4<-df3 %>% 
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  #filter(vacunatipo%in%c("INFLU")) %>% 
  
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  
  group_by(vacunatipo) %>% 
  
  st_as_sf %>%
  
  nest() %>% 
  
  mutate(
    
    grafico = map(.x = data,
                  .f = ~ggplot(data = .x %>%
         filter(ANIO%in%c(2010,2015,2019,2020)) %>% 
           mutate(
             siicat = ifelse(sii< -10,"< -10",
                             ifelse(sii>=-10&sii<=-5,"-10 to -5",
                                    ifelse(sii>=-5&sii<0,"-5 to 0",
                                           ifelse(sii>=0&sii<5,"0 to 5",
                                                  ifelse(sii>=5&sii<10,"5 to 10",
                                                         ifelse(sii>10,"> 10",NA)))))),
             
             
             siicat2 = factor(siicat, levels = c("< -10","-10 to -5","-5 to 0",
                                                "0 to 5","5 to 10","> 10"))
             
           )) +
           geom_sf(alpha = 0.5, aes(fill=siicat2)) +
           #scale_fill_gradient2(low  ="#0C6291", high = "#A63446", mid="#FBFEF9", midpoint = 0, limits = c(-20,20))+
           
           #scale_fill_manual(values = c("#FFC93C","#DBF6E9","#9DDFD3","#31326F"))+
           scale_fill_manual(values = c("#531a23","#a63446","#e4c2c7","#b6cfde","#0c6291","#084465"))+
           guides(fill=guide_legend(nrow=1))+
           labs(fill = "Slope Index of Inequality") +
           theme(axis.text.x = element_text(angle = 30, size = 6),
                 strip.background = element_blank(),
                 panel.background = element_blank(),
                 strip.text = element_text(face = "bold"),
                 legend.position = "bottom",
                 legend.title = element_text(size = 9, face = "bold"),
                 legend.key.size = unit(0.5, 'cm'))+
           facet_wrap(~ANIO, ncol = 4))
    )


g1<-plot_grid(df4$grafico[[1]] + theme(legend.position = "none"))
g2<-plot_grid(df4$grafico[[2]] + theme(legend.position = "none"))
g3<-plot_grid(df4$grafico[[3]] + theme(legend.position = "none"))
g4<-plot_grid(df4$grafico[[4]] + theme(legend.position = "none"))

legend<- get_legend(df4$grafico[[1]])

plot_grid(g1,g2,g3,g4,legend, ncol = 1, labels = c("A","B","C","D"), rel_heights = c(.6,.6,.6,.6,.2))


ggsave("Fig6.png",width = 10,height = 15)


```



```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(DEPARTAMEN,EDU_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    neumo = map(.x =df,
               .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                        orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                 
                 select(-MOV_NEUMO_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("EDU_MADRE") %>%
                     
                     mutate(
                       EDU_MADRE = substring(EDU_MADRE,10))) %>%
                 
                 select(DEPARTAMEN,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    rota = map(.x =df,
               .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                        orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                 
                 select(-MOV_ROTA_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("EDU_MADRE") %>%
                     
                     mutate(
                       EDU_MADRE = substring(EDU_MADRE,10))) %>%
                 
                 select(DEPARTAMEN,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
              .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                       orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                
                select(-MOV_INFLU_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(DEPARTAMEN,EDU_MADRE,total,orden,vacuna,vacunatipo,se,-`SE`))
    
  ) %>% 
  
  
  mutate(
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop.map(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii_map(.x))
    
  )


df4<-df3 %>% 
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  #filter(vacunatipo%in%c("INFLU")) %>% 
  
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  
  group_by(vacunatipo) %>% 
  
  st_as_sf %>%
  
  nest() %>% 
  
     mutate(
    
    grafico = map(.x = data,
                  .f = ~ggplot(data = .x %>%
         filter(ANIO%in%c(2010,2015,2019,2020)) %>% 
           mutate(
             siicat = ifelse(sii< -10,"< -10",
                             ifelse(sii>=-10&sii<=-5,"-10 to -5",
                                    ifelse(sii>=-5&sii<0,"-5 to 0",
                                           ifelse(sii>=0&sii<5,"0 to 5",
                                                  ifelse(sii>=5&sii<10,"5 to 10",
                                                         ifelse(sii>10,"> 10",NA)))))),
             
             
             siicat2 = factor(siicat, levels = c("< -10","-10 to -5","-5 to 0",
                                                "0 to 5","5 to 10","> 10"))
             
           )) +
           geom_sf(alpha = 0.5, aes(fill=siicat2)) +
           #scale_fill_gradient2(low  ="#0C6291", high = "#A63446", mid="#FBFEF9", midpoint = 0, limits = c(-20,20))+
           
           #scale_fill_manual(values = c("#FFC93C","#DBF6E9","#9DDFD3","#31326F"))+
           scale_fill_manual(values = c("#531a23","#a63446","#e4c2c7","#b6cfde","#0c6291","#084465"))+
           guides(fill=guide_legend(nrow=1))+
           labs(fill = "Slope Index of Inequality") +
           theme(axis.text.x = element_text(angle = 30, size = 6),
                 strip.background = element_blank(),
                 panel.background = element_blank(),
                 strip.text = element_text(face = "bold"),
                 legend.position = "bottom",
                 legend.title = element_text(size = 9, face = "bold"),
                 legend.key.size = unit(0.5, 'cm'))+
           facet_wrap(~ANIO, ncol = 4))
    )


g1<-plot_grid(df4$grafico[[1]] + theme(legend.position = "none"))
g2<-plot_grid(df4$grafico[[2]] + theme(legend.position = "none"))
g3<-plot_grid(df4$grafico[[3]] + theme(legend.position = "none"))
g4<-plot_grid(df4$grafico[[4]] + theme(legend.position = "none"))

legend<- get_legend(df4$grafico[[1]])

plot_grid(g1,g2,g3,g4,legend, ncol = 1, labels = c("A","B","C","D"), rel_heights = c(.6,.6,.6,.6,.2))


ggsave("Fig7.png",width = 10,height = 15)
```


# EVENTO: ANALISIS POR PROGRAMA JUNTOS

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  filter(ANIO !=2013) %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 1))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 0))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 1))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 0))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```  

```{r}
df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest()
```

### Graficos  
```{r}  
edu_juntos_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

edu_juntos_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(edu_juntos_si|edu_juntos_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("EDU_JUNTOS.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_JUNTOS_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_JUNTOS_tasas_no.png",width = 13, height = 9)

```

## INDICE DE RIQUEZA 

```{r}
df3<-
  df2 %>% 
  filter(ANIO!=2013) %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 1))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 0))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 1))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 0))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))
  

```  

### Graficos  
```{r}   
ir_juntos_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

ir_juntos_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(ir_juntos_si|ir_juntos_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("IR_JUNTOS.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_JUNTOS_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_JUNTOS_tasas_no.png",width = 13, height = 9)
```


#EVENTO: ANALISIS POR TIPO DE VIVIENDA

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```

### Graficos  
```{r} 
edu_vivienda_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

edu_vivienda_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(edu_vivienda_si|edu_vivienda_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("EDU_vivenda.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("EDU_vivenda_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("EDU_vivenda_tasas_no.png",width = 13, height = 9)
```



## INDICE RIQUEZA 

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```

### Graficos  
```{r} 

ir_vivienda_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

ir_vivienda_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(ir_vivienda_si|ir_vivienda_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("IR_vivienda.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_vivienda_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_vivienda_tasas_no.png",width = 13, height = 9)
```


#EVENTO: ANALISIS POR TIPO DE SEGURO

```{r}
MOV_GENERAL <- read.csv("./BD.INTERMEDIAS/mov_general.csv")

df2<-MOV_GENERAL %>% 
  
  mutate(
    tiposeguro = ifelse(CREDLUGAR == "H.MINSA/FFAA"|
                        CREDLUGAR == "H.ESSALUD"|
                        CREDLUGAR == "CS/POSTA MINSA"|
                        CREDLUGAR == "CS.ESSALUD", "Estado",
                        ifelse(CREDLUGAR == "OTRO/PRIVADO","Privado",NA))
  ) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data, 
      .f = ~svydesign(id =~ V001, strata =~ V022, probs=~V005, data=.x))) 

options(survey.lonely.psu="remove")

```


## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))


```


### Graficos  
```{r} 
edu_seguro_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

edu_seguro_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +

  xlab("Years")+
  ylab("Value")+
  #theme_minimal()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(edu_seguro_si|edu_seguro_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("EDU_seguro.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_seguro_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_seguro_tasas_no.png",width = 13, height = 9)
```


## INDICE RIQUEZA

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```


### Graficos  
```{r} 
ir_seguro_si<-
  df3 %>% select(ANIO,ssirii_si) %>% 
  unnest(cols = c(ssirii_si)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

ir_seguro_no<-
df3 %>% select(ANIO,ssirii_no) %>% 
  unnest(cols = c(ssirii_no)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = ssi, col = vacunatipo, group = vacunatipo), size  = 1.3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
    
  scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
    xlab("Years")+
    ylab("Value")+
    theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text( size = 8),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )


(ir_seguro_si|ir_seguro_no) + 
  plot_annotation(tag_levels = "A") +  
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

#ggsave("IR_seguro.png",width = 18)

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_seguro_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  
  mutate(
    derecha = cumsum(total) + 10*c(0:(nrow(t)-1)),
    izq = derecha - total,
    medio = (derecha + izq)/2
    ) %>% 
  
  nest() %>% 
  
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x,aes(xmin = izq, xmax = derecha, 
                                                   ymax = tasa, ymin = 0, 
                                                   fill = as.factor(ANIO),
                                                   group = as.factor(ANIO)))+
                         geom_rect(fill = "#AA5674", col = "black")+
                         geom_point(aes(x = medio, y = tasa))+
                         geom_smooth(aes(x = medio, y = tasa), method = "lm", se = F) +
                         xlab("Income quintile (1st - 5th)") +
                         ylab("Rate")+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_blank(),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

ggsave("IR_seguro_tasas_no.png",width = 13, height = 9)


```


# Panel - SII 
```{r}

p1<- plot_grid(edu_juntos_si + theme(legend.position = "none"),
               edu_juntos_no + theme(legend.position = "none"), rel_widths = c(1,1))

p2<- plot_grid(ir_juntos_si + theme(legend.position = "none"),
               ir_juntos_no + theme(legend.position = "none"), rel_widths = c(1,1))



p3<- plot_grid(edu_vivienda_si + theme(legend.position = "none"),
               edu_vivienda_no + theme(legend.position = "none"), rel_widths = c(1,1))

p4<- plot_grid(ir_vivienda_si + theme(legend.position = "none"),
               ir_vivienda_no + theme(legend.position = "none"), rel_widths = c(1,1))


p5<- plot_grid(edu_seguro_si + theme(legend.position = "none"),
               edu_seguro_no + theme(legend.position = "none"), rel_widths = c(1,1))

p6<- plot_grid(ir_seguro_si + theme(legend.position = "none"),
               ir_seguro_no + theme(legend.position = "none"), rel_widths = c(1,1))

legend<- get_legend(edu_juntos_si)

plot_grid(p1,p2,p3,p4,p5,p6,legend, cols = 1,labels = c("A","B","C","D","E","F"), rel_heights = c(1,1,1,1,1,1,.1))

ggsave("panel_sii.png",height = 15, width = 10)

```


# OTROS

## DEPARTAMENTOS

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~DEPARTAMEN, design = .x) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("DEPARTAMEN") %>%
                    
                    mutate(
                      DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
                
                select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~DEPARTAMEN, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("DEPARTAMEN") %>%
                      
                      mutate(
                        DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
                  
                  select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~DEPARTAMEN, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("DEPARTAMEN") %>%
                      
                      mutate(
                        DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
                  
                  select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~DEPARTAMEN, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("DEPARTAMEN") %>%
                      
                      mutate(
                        DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
                  
                  select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
     hr = map(.x = total,
              .f = ~h_prop(.x)),


     ssirii = map(.x = total,
                  .f = ~sii_rii(.x)),
    

     graf = map(.x = hr,
                .f = ~gg(.x))
    
  ) 

# SII y RII por año (2010 - 2020)

df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  pivot_longer(cols = c(ssi,rii), names_to = "index") %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  
  facet_wrap(~index)

  
# Grafico: tasa vs HR
ggsave("tt.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)



df3$hr[[1]]
 
  
  
```



## CRED LUGAR

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~CREDLUGAR, design = .x) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("CREDLUGAR") %>%
                    
                    mutate(
                      CREDLUGAR = substring(CREDLUGAR,10))) %>%
                
                select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~CREDLUGAR, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("CREDLUGAR") %>%
                      
                      mutate(
                        CREDLUGAR = substring(CREDLUGAR,10))) %>%
                  
                  select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~CREDLUGAR, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("CREDLUGAR") %>%
                      
                      mutate(
                        CREDLUGAR = substring(CREDLUGAR,10))) %>%
                  
                  select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~CREDLUGAR, design = .x) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("CREDLUGAR") %>%
                      
                      mutate(
                        CREDLUGAR = substring(CREDLUGAR,10))) %>%
                  
                  select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x)),
    
    
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  ) 

# SII y RII por año (2010 - 2020)

  df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  pivot_longer(cols = c(ssi,rii), names_to = "index") %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  
  facet_wrap(~index)

# Grafico: tasa vs HR
ggsave("qq.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)


  
```


## EDAD MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDAD_MADRE") %>%
                    
                    mutate(
                      EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
                
                select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDAD_MADRE") %>%
                    
                    mutate(
                      EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
                
                select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDAD_MADRE") %>%
                    
                    mutate(
                      EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
                
                select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDAD_MADRE") %>%
                    
                    mutate(
                      EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
                
                select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x)),
    
    
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  ) 


# SII y RII por año (2010 - 2020)

  df3 %>% select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  mutate(
    rii.pct = (rii-1)*100
  ) %>% 
  
  pivot_longer(cols = c(rii.pct,ssi), names_to = "index") %>% 
  
  ggplot() +
  geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
  facet_wrap(~index)

# Grafico: tasa vs HR
ggsave("uu.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)


```