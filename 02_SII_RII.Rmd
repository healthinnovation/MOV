---
title: "Untitled"
output: html_document
---

```{r, warning=F, message=F,comment=F}

library(tidyverse, warn.conflicts = F)
library(survey)
library(jtools)
library(sandwich)
library(sf)
library(extrafont)
library(patchwork)
library(cowplot)
library(ggsci)
library(estimatr)

region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")
```

# BASES

```{r}
# Base de trabajo
MOV_GENERAL <- read.csv("./BD.INTERMEDIAS/mov_general.csv")

df2<-MOV_GENERAL %>% 
  
  filter((CRED == "Si" | SEGURO == "Si")) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data, 
      .f = ~svydesign(id =~ V001, strata =~ V022, weights=~V005, data=.x))) 

options(survey.lonely.psu="remove")


```

# EVENTO: GENERAL

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3),
                       
                       vacuna_ll = MOV_PTV_e1 - (1.96 * se),
                       vacuna_hl = MOV_PTV_e1 + (1.96 * se)) %>% 
                
                select(-MOV_PTV_e1,-se) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10),
                      total_ll = total - (1.96 * SE),
                      total_hl = total + (1.96 * SE))) %>%
                
                select(EDU_MADRE,orden,total,total_ll,total_hl,
                       vacuna,vacuna_ll,vacuna_hl,vacunatipo)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3),
                         
                         vacuna_ll = vacuna - (1.96 * se),
                         vacuna_hl = vacuna + (1.96 * se)) %>% 
                  
                  select(-MOV_NEUMO_e1,-se) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10),
                        total_ll = total - (1.96 * SE),
                        total_hl = total + (1.96 * SE))) %>%
                  
                  select(EDU_MADRE,orden,total,total_ll,total_hl,
                         vacuna,vacuna_ll,vacuna_hl,vacunatipo)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3),
                         
                         vacuna_ll = vacuna - (1.96 * se),
                         vacuna_hl = vacuna + (1.96 * se)) %>% 
                  
                  select(-MOV_INFLU_e1,-se) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10),
                        total_ll = total - (1.96 * SE),
                        total_hl = total + (1.96 * SE))) %>%
                  
                  select(EDU_MADRE,orden,total,total_ll,total_hl,
                         vacuna,vacuna_ll,vacuna_hl,vacunatipo)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3),
                         
                         vacuna_ll = vacuna - (1.96 * se),
                         vacuna_hl = vacuna + (1.96 * se)) %>% 
                  
                  select(-MOV_ROTA_e1,-se) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10),
                        total_ll = total - (1.96 * SE),
                        total_hl = total + (1.96 * SE))) %>%
                  
                  select(EDU_MADRE,orden,total,total_ll,total_hl,
                         vacuna,vacuna_ll,vacuna_hl,vacunatipo))) %>% 
  
  
  mutate(
    
    total = map(.x = ptv,
                .f = ~bind_rows(.x,neumo,influ,rota)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x)),
    
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x)),
  
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  )  

 
```

## Graficos

```{r}
# SII y RII por a√±o (2010 - 2020)

  ssi.edu<-
    df3 %>% select(ANIO,ssirii) %>% 
  unnest() %>% 
  as.data.frame() %>%
  
  ggplot(aes(x = ANIO, y = ssi, group = vacunatipo)) +
  
  geom_line(aes(color = vacunatipo), size = 1.2) +
  geom_ribbon(aes(ymin = sii_l, ymax = sii_h, fill = vacunatipo), alpha = 0.1)+
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+
  
  xlab("Years")+
  ylab("SII")+
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
  theme_bw()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "top",
    legend.title = element_blank(),
    #axis.line = element_line(colour = "black", size = 1),
    panel.grid = element_blank(),
    #strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )
  

#########


temp<-df3 %>% 
  select(ANIO,hr) %>% 
  unnest(cols = c(hr)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO))
  
  
  
temp$derecha <- cumsum(temp$total) + 5*c(0:(nrow(temp)-1))
  
temp2<-
  temp %>% 
    mutate(
    izq = derecha - total,
    medio = (derecha + izq)/2
    ) %>% 
  
  nest() %>% 
  
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x,aes(xmin = izq, xmax = derecha, 
                                                   ymax = tasa, ymin = 0, 
                                                   fill = as.factor(ANIO),
                                                   group = as.factor(ANIO)))+
                         geom_rect(fill = "#AA5674", col = "black", width = 0.5)+
                         geom_point(aes(x = medio, y = tasa))+
                         geom_smooth(aes(x = medio, y = tasa), method = "lm", se = F) +
                         xlab("Income quintile (1st - 5th)") +
                         ylab("Rate")+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_blank(),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


# cowplot::plot_grid(plotlist = temp2$grafico)
# 
# ggsave("cols_slope_education.png", width = 13, height = 9)
ssi.edu
```

## INDICE RIQUEZA

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop(.x,3)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii(.x,3)),
    
    
    graf = map(.x = hr,
               .f = ~gg(.x))
    
  ) 



```

## Graficos

```{r}
# SII y RII por a√±o (2010 - 2020)

ssi.ir<-
   df3 %>% select(ANIO,ssirii) %>% 
  unnest() %>% 
  as.data.frame() %>%
  
  ggplot(aes(x = ANIO, y = ssi, group = vacunatipo)) +
  
  geom_line(aes(color = vacunatipo), size = 1.2) +
  geom_ribbon(aes(ymin = sii_l, ymax = sii_h, fill = vacunatipo), alpha = 0.1)+
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+
  
  xlab("Years")+
  ylab("SII")+
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
  theme_bw()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "top",
    legend.title = element_blank(),
    #axis.line = element_line(colour = "black", size = 1),
    panel.grid = element_blank(),
    #strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )

#ggsave("SII_RII_RIQ.png",width = 18, height = 5)


#######

temp<-df3 %>% 
  select(ANIO,hr) %>% 
  unnest(cols = c(hr)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO))


temp$derecha <- cumsum(temp$total) + 5*c(0:(nrow(temp)-1))
  
temp2<-
  temp %>% 
    mutate(
    izq = derecha - total,
    medio = (derecha + izq)/2
    ) %>% 
  
  nest() %>% 
  
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x,aes(xmin = izq, xmax = derecha, 
                                                   ymax = tasa, ymin = 0, 
                                                   fill = as.factor(ANIO),
                                                   group = as.factor(ANIO)))+
                         geom_rect(fill = "#AA5674", col = "black")+
                         geom_point(aes(x = medio, y = tasa))+
                         geom_smooth(aes(x = medio, y = tasa), method = "lm", se = F) +
                         xlab("Income quintile (1st - 5th)") +
                         ylab("Rate")+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_blank(),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))

# 
# cowplot::plot_grid(plotlist = temp2$grafico)
# 
# ggsave("cols_slope_RIQ.png", width = 13, height = 9)


```

# EVENTO POR REGION

### IR

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(DEPARTAMEN,INDICERIQUEZA,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    neumo = map(.x =df,
               .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                        orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                 
                 select(-MOV_NEUMO_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("INDICERIQUEZA") %>%
                     
                     mutate(
                       INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                 
                 select(DEPARTAMEN,INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    rota = map(.x =df,
               .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                        orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                 
                 select(-MOV_ROTA_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("INDICERIQUEZA") %>%
                     
                     mutate(
                       INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                 
                 select(DEPARTAMEN,INDICERIQUEZA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
              .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_INFLU_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(DEPARTAMEN,INDICERIQUEZA,total,orden,vacuna,vacunatipo,se,-`SE`))
    
  ) %>% 
  
  
  mutate(
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop.map(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii_map(.x))
    
  )


```

#### Graficos - IR

```{r}

centroid<- region_shape %>% 
  sf::st_centroid() %>% 
  st_coordinates() %>% 
  as.data.frame() %>% 
  bind_cols(region_shape) %>% 
  filter(CAPITAL != "CALLAO") %>% 
  mutate(
    CAP = substr(DEPARTAMEN, start = 1, stop = 2),
    CAP = ifelse(DEPARTAMEN == "HUANCAVELICA","HV",
                 ifelse(DEPARTAMEN == "LA LIBERTAD","LL",CAP))
  )
  

df4<-df3 %>% 
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  #filter(vacunatipo%in%c("INFLU")) %>% 
  
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  
  group_by(vacunatipo) %>% 
  
  st_as_sf() %>%
  
  nest() %>% 
  
  mutate(
    
    grafico = map(.x = data,
                  .f = ~ggplot(data = .x %>%
                                 
         filter(ANIO%in%c(2010,2015,2019,2020)) %>% 
         mutate(
           siicat = ifelse(sii< -10,"< -10",
                           ifelse(sii>=-10&sii<=-5,"-10 to -5",
                                  ifelse(sii>=-5&sii<0,"-5 to 0",
                                         ifelse(sii>=0&sii<5,"0 to 5",
                                                ifelse(sii>=5&sii<10,"5 to 10",
                                                       ifelse(sii>10,"> 10",NA)))))),
           
           
           siicat2 = factor(siicat, levels = c("< -10","-10 to -5","-5 to 0",
                                               "0 to 5","5 to 10","> 10"))
           
         )) +
  geom_sf(alpha = 0.5, aes(fill=siicat2)) +
  geom_text(data=centroid, aes(x = X, y = Y, label = CAP), size = 1.5)+

  scale_fill_manual(values = c("#531a23","#a63446","#e4c2c7","#b6cfde","#0c6291","#084465"))+
  
  guides(fill=guide_legend(
    direction = "horizontal",
    keyheight = unit(4, units = "mm"),
    keywidth = unit(20, units = "mm"),
    title.position = 'top',
    title.hjust = 0.5,
    label.hjust = 1,
    nrow = 1,
    byrow = T,
    label.position = "bottom"
  ))+
    facet_wrap(~ANIO, ncol = 4)+
  
  labs(fill = "Slope Index of Inequality") +
  
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 30, size = 6),
        strip.background = element_blank(),
        panel.background = element_blank(),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 9, face = "bold"),
        legend.key.size = unit(0.5, 'cm'))
    ))
    


g1<-plot_grid(df4$grafico[[1]] + theme(legend.position = "none"))
g2<-plot_grid(df4$grafico[[2]] + theme(legend.position = "none"))
g3<-plot_grid(df4$grafico[[3]] + theme(legend.position = "none"))
g4<-plot_grid(df4$grafico[[4]] + theme(legend.position = "none"))

legend<- get_legend(df4$grafico[[1]])

plot_grid(g1,g2,g3,g4,legend, ncol = 1, labels = c("A","B","C","D"), rel_heights = c(.6,.6,.6,.6,.2))


 ggsave("Fig6.png",width = 10,height = 15)

```

#### Moran's I - IR

```{r}
library(spdep)

 data<-
  df3 %>% 
  
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  group_by(ANIO,vacunatipo) %>%
  st_as_sf() %>% 
  nest() %>% 
    mutate(
      nb= map(.x = data,
               .f = ~poly2nb(.x, queen = T)),
      
      lw = map(.x = nb,
               .f = ~nb2listw(.x, style = "W", zero.policy = T)),
      
      
      moran = map2(.x = data, .y = lw,
                     .f = ~moran.test(.x$sii,.y,alternative = "greater")),
      
      moran.mc = map2(.x = data, .y = lw,
                      .f = ~moran.mc(.x$sii,.y, nsim = 9999, alternative = "greater")),
      
      
      moran.t = map_dbl(.x = moran,
                        .f = ~.x$estimate[[1]]),
      
      moran.p = map_dbl(.x = moran,
                        .f = ~.x$p.value)
    )
 
 
 moran.ir<-
   data %>% 
  select(ANIO,vacunatipo,moran.t,moran.p) %>% 
  mutate(
    alpha = ifelse(moran.p>0.05,0.4,1)
  ) %>% 

  ggplot(aes(x = as.factor(ANIO), y = vacunatipo, fill = moran.t, alpha = alpha))+
  geom_tile()+
  #scale_x_discrete(position = "top") +
  scale_fill_gradient(high = "#073a57", low ="#b6cfde", limits = c(0.01,0.40))+
  geom_text(aes(label = formatC(round(moran.t, 2), format = "f", digits = 2)), size = 3.5)+
  scale_x_discrete(position = "top") +
  labs(x = "", y = NULL) +
  guides(alpha = "none",
         fill = "none")+
  theme_minimal()+
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_text(size = 10, face = "bold"),
    axis.text.y = element_text(size = 8, face = "bold"),
    axis.text.x = element_blank()
  )
 

```

### ME

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(DEPARTAMEN,EDU_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    neumo = map(.x =df,
               .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                        orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                 
                 select(-MOV_NEUMO_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("EDU_MADRE") %>%
                     
                     mutate(
                       EDU_MADRE = substring(EDU_MADRE,10))) %>%
                 
                 select(DEPARTAMEN,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    rota = map(.x =df,
               .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                 
                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                        orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                 
                 select(-MOV_ROTA_e1) %>% 
                 
                 left_join(
                   
                   svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                     
                     data.frame() %>%
                     
                     rownames_to_column("EDU_MADRE") %>%
                     
                     mutate(
                       EDU_MADRE = substring(EDU_MADRE,10))) %>%
                 
                 select(DEPARTAMEN,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
              .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                       orden =as.numeric(as.factor(EDU_MADRE))) %>% 
                
                select(-MOV_INFLU_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(DEPARTAMEN,EDU_MADRE,total,orden,vacuna,vacunatipo,se,-`SE`))
    
  ) %>% 
  
  
  mutate(
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr = map(.x = total,
             .f = ~h_prop.map(.x)),
    
    ssirii = map(.x = total,
                 .f = ~sii_rii_map(.x))
    
  )

```

#### Grafico - ME

```{r}
df4<-df3 %>% 
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  #filter(vacunatipo%in%c("INFLU")) %>% 
  
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  
  group_by(vacunatipo) %>% 
  
  st_as_sf %>%
  
  nest() %>% 
  
     mutate(
    
    grafico = map(.x = data,
                  .f = ~ggplot(data = .x %>%
                                 
         filter(ANIO%in%c(2010,2015,2019,2020)) %>% 
         mutate(
           siicat = ifelse(sii< -10,"< -10",
                           ifelse(sii>=-10&sii<=-5,"-10 to -5",
                                  ifelse(sii>=-5&sii<0,"-5 to 0",
                                         ifelse(sii>=0&sii<5,"0 to 5",
                                                ifelse(sii>=5&sii<10,"5 to 10",
                                                       ifelse(sii>10,"> 10",NA)))))),
           
           
           siicat2 = factor(siicat, levels = c("< -10","-10 to -5","-5 to 0",
                                               "0 to 5","5 to 10","> 10"))
           
         )) +
  geom_sf(alpha = 0.5, aes(fill=siicat2)) +

  scale_fill_manual(values = c("#531a23","#a63446","#e4c2c7","#b6cfde","#0c6291","#084465"))+
  
  guides(fill=guide_legend(
    direction = "horizontal",
    keyheight = unit(4, units = "mm"),
    keywidth = unit(20, units = "mm"),
    title.position = 'top',
    title.hjust = 0.5,
    label.hjust = 1,
    nrow = 1,
    byrow = T,
    label.position = "bottom"
  ))+
    facet_wrap(~ANIO, ncol = 4)+
  
  labs(fill = "Slope Index of Inequality") +
  
  theme(axis.text.x = element_text(angle = 30, size = 6),
        strip.background = element_blank(),
        panel.background = element_blank(),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 9, face = "bold"),
        legend.key.size = unit(0.5, 'cm'))
    ))


g1<-plot_grid(df4$grafico[[1]] + theme(legend.position = "none"))
g2<-plot_grid(df4$grafico[[2]] + theme(legend.position = "none"))
g3<-plot_grid(df4$grafico[[3]] + theme(legend.position = "none"))
g4<-plot_grid(df4$grafico[[4]] + theme(legend.position = "none"))

#legend<- get_legend(df4$grafico[[1]])

plot_grid(g1,g2,g3,g4,legend, ncol = 1, labels = c("A","B","C","D"), rel_heights = c(.6,.6,.6,.6,.2))


 ggsave("Fig7.png",width = 10,height = 15)
```

#### Moran's I - ME

```{r}
data<-
  df3 %>% 
  
  select(ANIO,ssirii) %>% 
  unnest(cols = c(ssirii)) %>%
  left_join(region_shape, by = "DEPARTAMEN") %>% 
  group_by(ANIO,vacunatipo) %>%
  st_as_sf() %>% 
  nest() %>% 
    mutate(
      nb= map(.x = data,
               .f = ~poly2nb(.x, queen = T)),
      
      lw = map(.x = nb,
               .f = ~nb2listw(.x, style = "W", zero.policy = T)),
      
      
      moran = map2(.x = data, .y = lw,
                     .f = ~moran.test(.x$sii,.y,alternative = "greater")),
      
      moran.mc = map2(.x = data, .y = lw,
                      .f = ~moran.mc(.x$sii,.y, nsim = 9999, alternative = "greater")),
      
      
      moran.t = map_dbl(.x = moran,
                        .f = ~.x$estimate[[1]]),
      
      moran.p = map_dbl(.x = moran,
                        .f = ~.x$p.value)
    )
 
 
  moran.me<-
   data %>% 
  select(ANIO,vacunatipo,moran.t,moran.p) %>% 
  mutate(
    alpha = ifelse(moran.p>0.05,0.2,1)
  ) %>% 

  ggplot(aes(x = as.factor(ANIO), y = vacunatipo, fill = moran.t, alpha = alpha))+
  geom_tile()+
  scale_fill_gradient(high = "#073a57", low ="#b6cfde", limits = c(0.01,0.40))+
  geom_text(aes(label = formatC(round(moran.t, 2), format = "f", digits = 2)), size = 3.5)+
  scale_x_discrete(position = "top") +
  labs(x = "", y = NULL) +
  guides(alpha = "none",
         fill = "none")+
  theme_minimal()+
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_text(size = 10, face = "bold"),
    axis.text.y = element_text(size = 8, face = "bold"),
    axis.text.x = element_blank()
  )
```

###Grafico Moran's I + SII

```{r}

legend <- get_legend(ssi.edu)

ssi.edu<- ssi.edu + theme(legend.position = "none")
ssi.ir<- ssi.ir + theme(legend.position = "none")

graficoa<-plot_grid(moran.me,ssi.edu, ncol = 1, rel_heights = c(.4,1))
graficob<-plot_grid(moran.ir,ssi.ir, ncol = 1, rel_heights = c(.4,1))

cowplot::plot_grid(graficoa,graficob,legend, ncol = 1, labels = c("A","B"), rel_heights = c(1,1,0.1))

ggsave("Fig4.png", width =11, height = 13)
```

# EVENTO: ANALISIS POR PROGRAMA JUNTOS

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  filter(ANIO !=2013) %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(JUNTOS,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 1))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 0))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 1))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 0))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))


```

### Graficos

```{r}
edu<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
    mutate(
    estrato = "edu"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_JUNTOS_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_JUNTOS_tasas_no.png",width = 13, height = 9)

```

## INDICE DE RIQUEZA

```{r}
df3<-
  df2 %>% 
  filter(ANIO!=2013) %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA + JUNTOS, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + JUNTOS, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,JUNTOS,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 1))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(JUNTOS == 0))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 1))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(JUNTOS == 0))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))
  

df3$ptv[[1]]
```

### Graficos

```{r}

riq<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
  mutate(
    estrato = "riq"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("IR_JUNTOS_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("IR_JUNTOS_tasas_no.png",width = 13, height = 9)
```

```{r}
juntos<-
  bind_rows(riq,edu) %>% 
  mutate(
    var = ifelse(var == "ssirii_si","Social program","No social program"),
    estrato = ifelse(estrato == "edu","ME","IQ")
  ) %>% 
  ggplot(aes(x = ANIO, y = ssi, group = vacunatipo)) +
  
  geom_line(aes(color = vacunatipo), size = 1.2) +
  geom_ribbon(aes(ymin = sii_l, ymax = sii_h, fill = vacunatipo), alpha = 0.1)+
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+
  
  facet_grid(estrato~var, scales = "free") +
    xlab("Years")+
    ylab("SII")+
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
    theme_bw()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "top",
    legend.title = element_blank(),
    #axis.line = element_line(colour = "black", size = 1),
    panel.grid = element_blank(),
    #strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9),
    panel.spacing = unit(1.5, "lines")
  )

juntos.df<-bind_rows(riq,edu)
```

#EVENTO: ANALISIS POR TIPO DE VIVIENDA

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(TIPORESIDENCIA,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```

### Graficos

```{r}

edu<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
    mutate(
    estrato = "edu"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_vivenda_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_vivenda_tasas_no.png",width = 13, height = 9)
```

## INDICE RIQUEZA

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + TIPORESIDENCIA, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,TIPORESIDENCIA,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "RURAL"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(TIPORESIDENCIA == "URBANO"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```

### Graficos

```{r}

riq<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
  mutate(
    estrato = "riq"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("IR_vivienda_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("IR_vivienda_tasas_no.png",width = 13, height = 9)
```

```{r}
tipovivienda<-
  vivienda.df %>% 
  mutate(
    var = ifelse(var == "ssirii_si","Rural","Urban"),
    estrato = ifelse(estrato == "edu","ME","IQ")
  ) %>% 
  ggplot(aes(x = ANIO, y = ssi, group = vacunatipo)) +
  
  geom_line(aes(color = vacunatipo), size = 1.2) +
  geom_ribbon(aes(ymin = sii_l, ymax = sii_h, fill = vacunatipo), alpha = 0.1)+
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+
  
  #scale_color_manual(values = c("#595260","#7ECA9C","#A799B7","#AD6C80")) +
  
  facet_grid(estrato~var, scales = "free") +
    xlab("Years")+
    ylab("SII")+
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
    theme_bw()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "top",
    legend.title = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold", size = 9),
    panel.spacing = unit(1.5, "lines")
  )

vivienda.df<-bind_rows(riq,edu)
```

#EVENTO: ANALISIS POR TIPO DE SEGURO

```{r}
MOV_GENERAL <- read.csv("./BD.INTERMEDIAS/mov_general.csv")

df2<-MOV_GENERAL %>% 
  
  mutate(
    tiposeguro = ifelse(CREDLUGAR == "H.MINSA/FFAA"|
                        CREDLUGAR == "H.ESSALUD"|
                        CREDLUGAR == "CS/POSTA MINSA"|
                        CREDLUGAR == "CS.ESSALUD", "Estado",
                        ifelse(CREDLUGAR == "OTRO/PRIVADO","Privado",NA))
  ) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data, 
      .f = ~svydesign(id =~ V001, strata =~ V022, probs=~V005, data=.x))) 

options(survey.lonely.psu="remove")

```

## EDUCACION DE LA MADRE

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3)) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("EDU_MADRE") %>%
                    
                    mutate(
                      EDU_MADRE = substring(EDU_MADRE,10))) %>%
                
                select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE+tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden = case_when(EDU_MADRE == "sin educ" ~ 0,
                                           EDU_MADRE == "primaria" ~ 1,
                                           EDU_MADRE == "secundaria" ~ 2,
                                           EDU_MADRE == "superior" ~ 3)) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~EDU_MADRE, design =.x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("EDU_MADRE") %>%
                      
                      mutate(
                        EDU_MADRE = substring(EDU_MADRE,10))) %>%
                  
                  select(tiposeguro,EDU_MADRE,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))


```

### Graficos

```{r}

edu<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
    mutate(
    estrato = "edu"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_seguro_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = EDU_MADRE, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Maternal education") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("1st","2nd","3rd","4th","5th"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("EDU_seguro_tasas_no.png",width = 13, height = 9)
```

## INDICE RIQUEZA

```{r}
df3<-
  df2 %>% 
  mutate(
    
    ptv = map(.x =df,
              .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                
                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
                       orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                
                select(-MOV_PTV_e1) %>% 
                
                left_join(
                  
                  svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                    
                    data.frame() %>%
                    
                    rownames_to_column("INDICERIQUEZA") %>%
                    
                    mutate(
                      INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                
                select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    
    neumo = map(.x =df,
                .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_NEUMO_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    influ = map(.x =df,
                .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_INFLU_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`)),
    
    
    rota  = map(.x =df,
                .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA + tiposeguro, design =.x, FUN=svytotal, na.rm = T) %>% 
                  
                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
                         orden =as.numeric(as.factor(INDICERIQUEZA))) %>% 
                  
                  select(-MOV_ROTA_e1) %>% 
                  
                  left_join(
                    
                    svytotal(~INDICERIQUEZA, design = .x, na.rm = T) %>%
                      
                      data.frame() %>%
                      
                      rownames_to_column("INDICERIQUEZA") %>%
                      
                      mutate(
                        INDICERIQUEZA = substring(INDICERIQUEZA,14))) %>%
                  
                  select(INDICERIQUEZA,tiposeguro,orden,total,vacuna,vacunatipo,se,-`SE`))) %>% 
  
  
  mutate(
    
    pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
    pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
    
    total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
    
    hr_si = map(.x = total,
             .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    hr_no = map(.x = total ,
                .f = ~h_prop(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    ssirii_si = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Estado"))),
    
    ssirii_no = map(.x = total ,
                 .f = ~sii_rii(.x %>% dplyr::filter(tiposeguro == "Privado"))),
    
    
    graf_si = map(.x = hr_si,
               .f = ~gg(.x)),
    
    graf_no = map(.x = hr_no,
                  .f = ~gg(.x)))

```

### Graficos

```{r}

riq<-df3 %>% 
  select(ANIO,ssirii_si,ssirii_no) %>%
  gather(var,value,ssirii_si:ssirii_no) %>% 
  unnest() %>% 
  mutate(
    estrato = "riq"
  )

#####

temp<-df3 %>% 
  select(ANIO,hr_si) %>% 
  unnest(cols = c(hr_si)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO)) %>% 
  nest() %>% 
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x, aes(x = INDICERIQUEZA, y = tasa, fill = as.factor(ANIO), group = as.factor(ANIO)))+
                         geom_col(fill = "#AA5674")+
                         geom_point()+
                         geom_smooth(method = "lm",se = F)+
                         xlab("Poverty quintile") +
                         ylab("Rate")+
                         scale_x_discrete(labels = c("NE","PS","HS","SE"))+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_text( size = 8),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)

#ggsave("IR_seguro_tasas_si.png",width = 13, height = 9)


#####  

temp<-df3 %>% 
  select(ANIO,hr_no) %>% 
  unnest(cols = c(hr_no)) %>% 
  as.data.frame() %>% 
  group_by(as.factor(ANIO))

temp$derecha <- cumsum(temp$total) + 10*c(0:(nrow(temp)-1))
  
temp2<-
  temp %>% 
    mutate(
    izq = derecha - total,
    medio = (derecha + izq)/2
    ) %>% 
  
  nest() %>% 
  
  mutate(grafico = map(.x = data,
                       .f = ~ggplot(data = .x,aes(xmin = izq, xmax = derecha, 
                                                   ymax = tasa, ymin = 0, 
                                                   fill = as.factor(ANIO),
                                                   group = as.factor(ANIO)))+
                         geom_rect(fill = "#AA5674", col = "black")+
                         geom_point(aes(x = medio, y = tasa))+
                         geom_smooth(aes(x = medio, y = tasa), method = "lm", se = F) +
                         xlab("Income quintile (1st - 5th)") +
                         ylab("Rate")+
                         theme(
                           axis.title = element_text(face ="bold", size = 8),
                           legend.text = element_text(size = 9, face = "bold"),
                           axis.text = element_text(face = "bold"),
                           axis.text.x = element_blank(),
                           legend.position = "top",
                           legend.title = element_blank(),
                           axis.line = element_line(colour = "black", size = 1),
                           panel.background = element_blank(),
                           strip.background = element_blank(),
                           strip.text = element_text(face = "bold", size = 8)) +
                         facet_wrap(~vacunatipo, scales = "free")))


cowplot::plot_grid(plotlist = temp$grafico)


#ggsave("IR_seguro_tasas_no.png",width = 13, height = 9)





```


```{r}
tipocred<-
  bind_rows(riq,edu) %>% 
  mutate(
    var = ifelse(var == "ssirii_si","Goverment","Private"),
    estrato = ifelse(estrato == "edu","ME","IQ")
  ) %>% 
  ggplot(aes(x = ANIO, y = ssi, group = vacunatipo)) +
  
  geom_line(aes(color = vacunatipo), size = 1.2) +
  geom_ribbon(aes(ymin = sii_l, ymax = sii_h, fill = vacunatipo), alpha = 0.1)+
  geom_hline(aes(yintercept = 0), linetype = "dashed") + 
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+
  
  facet_grid(estrato~var, scales = "free", space = "free_x") +
    xlab("Years")+
    ylab("SII")+
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
    theme_bw()+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "top",
    legend.title = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold", size = 9),
    panel.spacing = unit(1.5, "lines")
  )

ir.df <- bind_rows(riq,edu) 
```

# Panel - SII

```{r}

p1<- plot_grid(juntos + theme(legend.position = "none"))

p2<- plot_grid(tipovivienda + theme(legend.position = "none"))

p3<- plot_grid(tipocred + theme(legend.position = "none"))



legend<- get_legend(juntos)

plot_grid(p1,p2,p3,legend, cols = 1,labels = c("A","B","C"), rel_heights = c(1,1,1,.1))

ggsave("panel_sii.png",height = 13, width = 9)

```

# OTROS

## DEPARTAMENTOS

```{r, eval= F}
# df3<-
#   df2 %>% 
#   mutate(
#     
#     ptv = map(.x =df,
#               .f = ~svyby(~MOV_PTV_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV",
#                        orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
#                 
#                 select(-MOV_PTV_e1) %>% 
#                 
#                 left_join(
#                   
#                   svytotal(~DEPARTAMEN, design = .x) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("DEPARTAMEN") %>%
#                     
#                     mutate(
#                       DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
#                 
#                 select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
#     
#     
#     
#     neumo = map(.x =df,
#                 .f = ~svyby(~MOV_NEUMO_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO",
#                          orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
#                   
#                   select(-MOV_NEUMO_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~DEPARTAMEN, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("DEPARTAMEN") %>%
#                       
#                       mutate(
#                         DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
#                   
#                   select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
#     
#     
#     influ = map(.x =df,
#                 .f = ~svyby(~MOV_INFLU_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU",
#                          orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
#                   
#                   select(-MOV_INFLU_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~DEPARTAMEN, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("DEPARTAMEN") %>%
#                       
#                       mutate(
#                         DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
#                   
#                   select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`)),
#     
#     
#     rota  = map(.x =df,
#                 .f = ~svyby(~MOV_ROTA_e1, by=~DEPARTAMEN, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA",
#                          orden =as.numeric(as.factor(DEPARTAMEN))) %>% 
#                   
#                   select(-MOV_ROTA_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~DEPARTAMEN, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("DEPARTAMEN") %>%
#                       
#                       mutate(
#                         DEPARTAMEN = substring(DEPARTAMEN,11))) %>%
#                   
#                   select(DEPARTAMEN,total,vacuna,vacunatipo,se,orden,-`SE`))) %>% 
#   
#   
#   mutate(
#     
#     pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#     pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#     
#     total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#     
#      hr = map(.x = total,
#               .f = ~h_prop(.x)),
# 
# 
#      ssirii = map(.x = total,
#                   .f = ~sii_rii(.x)),
#     
# 
#      graf = map(.x = hr,
#                 .f = ~gg(.x))
#     
#   ) 
# 
# # SII y RII por a√±o (2010 - 2020)
# 
# df3 %>% select(ANIO,ssirii) %>% 
#   unnest(cols = c(ssirii)) %>% 
#   as.data.frame() %>% 
#   ungroup() %>% 
#   pivot_longer(cols = c(ssi,rii), names_to = "index") %>% 
#   
#   ggplot() +
#   geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   
#   facet_wrap(~index)

  
# Grafico: tasa vs HR
#ggsave("tt.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)

  
```

## CRED LUGAR

```{r}
# df3<-
#   df2 %>% 
#   mutate(
#     
#     ptv = map(.x =df,
#               .f = ~svyby(~MOV_PTV_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>% 
#                 
#                 select(-MOV_PTV_e1) %>% 
#                 
#                 left_join(
#                   
#                   svytotal(~CREDLUGAR, design = .x) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("CREDLUGAR") %>%
#                     
#                     mutate(
#                       CREDLUGAR = substring(CREDLUGAR,10))) %>%
#                 
#                 select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     
#     neumo = map(.x =df,
#                 .f = ~svyby(~MOV_NEUMO_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>% 
#                   
#                   select(-MOV_NEUMO_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~CREDLUGAR, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("CREDLUGAR") %>%
#                       
#                       mutate(
#                         CREDLUGAR = substring(CREDLUGAR,10))) %>%
#                   
#                   select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     influ = map(.x =df,
#                 .f = ~svyby(~MOV_INFLU_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>% 
#                   
#                   select(-MOV_INFLU_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~CREDLUGAR, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("CREDLUGAR") %>%
#                       
#                       mutate(
#                         CREDLUGAR = substring(CREDLUGAR,10))) %>%
#                   
#                   select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     rota  = map(.x =df,
#                 .f = ~svyby(~MOV_ROTA_e1, by=~CREDLUGAR, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
#                   
#                   select(-MOV_ROTA_e1) %>% 
#                   
#                   left_join(
#                     
#                     svytotal(~CREDLUGAR, design = .x) %>%
#                       
#                       data.frame() %>%
#                       
#                       rownames_to_column("CREDLUGAR") %>%
#                       
#                       mutate(
#                         CREDLUGAR = substring(CREDLUGAR,10))) %>%
#                   
#                   select(CREDLUGAR,total,vacuna,vacunatipo,se,-`SE`))) %>% 
#   
#   
#   mutate(
#     
#     pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#     pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#     
#     total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#     
#     hr = map(.x = total,
#              .f = ~h_prop(.x)),
#     
#     ssirii = map(.x = total,
#                  .f = ~sii_rii(.x)),
#     
#     
#     graf = map(.x = hr,
#                .f = ~gg(.x))
#     
#   ) 
# 
# # SII y RII por a√±o (2010 - 2020)
# 
#   df3 %>% select(ANIO,ssirii) %>% 
#   unnest(cols = c(ssirii)) %>% 
#   as.data.frame() %>% 
#   ungroup() %>% 
#   pivot_longer(cols = c(ssi,rii), names_to = "index") %>% 
#   
#   ggplot() +
#   geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   
#   facet_wrap(~index)
# 
# # Grafico: tasa vs HR
# ggsave("qq.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)


  
```

## EDAD MADRE

```{r}
# df3<-
#   df2 %>% 
#   mutate(
#     
#     ptv = map(.x =df,
#               .f = ~svyby(~MOV_PTV_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>% 
#                 
#                 select(-MOV_PTV_e1) %>% 
#                 
#                 left_join(
#                   
#                   svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("EDAD_MADRE") %>%
#                     
#                     mutate(
#                       EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
#                 
#                 select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     
#     neumo = map(.x =df,
#                 .f = ~svyby(~MOV_NEUMO_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>% 
#                   
#                   select(-MOV_NEUMO_e1) %>% 
#                   
#                   left_join(
#                   
#                   svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("EDAD_MADRE") %>%
#                     
#                     mutate(
#                       EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
#                 
#                 select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     influ = map(.x =df,
#                 .f = ~svyby(~MOV_INFLU_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>% 
#                   
#                   select(-MOV_INFLU_e1) %>% 
#                   
#                   left_join(
#                   
#                   svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("EDAD_MADRE") %>%
#                     
#                     mutate(
#                       EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
#                 
#                 select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`)),
#     
#     
#     rota  = map(.x =df,
#                 .f = ~svyby(~MOV_ROTA_e1, by=~EDAD_MADRE, design =.x, FUN=svytotal, na.rm = T) %>% 
#                   
#                   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
#                   
#                   select(-MOV_ROTA_e1) %>% 
#                   
#                   left_join(
#                   
#                   svytotal(~EDAD_MADRE, design = .x, na.rm = T) %>%
#                     
#                     data.frame() %>%
#                     
#                     rownames_to_column("EDAD_MADRE") %>%
#                     
#                     mutate(
#                       EDAD_MADRE = substring(EDAD_MADRE,11))) %>%
#                 
#                 select(EDAD_MADRE,total,vacuna,vacunatipo,se,-`SE`))) %>% 
#   
#   
#   mutate(
#     
#     pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#     pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#     
#     total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#     
#     hr = map(.x = total,
#              .f = ~h_prop(.x)),
#     
#     ssirii = map(.x = total,
#                  .f = ~sii_rii(.x)),
#     
#     
#     graf = map(.x = hr,
#                .f = ~gg(.x))
#     
#   ) 
# 
# 
# # SII y RII por a√±o (2010 - 2020)
# 
#   df3 %>% select(ANIO,ssirii) %>% 
#   unnest(cols = c(ssirii)) %>% 
#   as.data.frame() %>% 
#   ungroup() %>% 
#   mutate(
#     rii.pct = (rii-1)*100
#   ) %>% 
#   
#   pivot_longer(cols = c(rii.pct,ssi), names_to = "index") %>% 
#   
#   ggplot() +
#   geom_line(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   geom_point(aes(x = as.factor(ANIO), y = value, col = vacunatipo, group = vacunatipo)) +
#   facet_wrap(~index)
# 
# # Grafico: tasa vs HR
# ggsave("uu.png",cowplot::plot_grid(plotlist = df3$graf), width = 18, height = 15)


```
