---
title: "MOV 1"
author: "jose"
date: "18/6/2021"
output:
  html_document:
    code_folding: hide
    fig_height: 6
    fig_width: 9
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

# Bases

```{r, echo=F, warning=F, message=F, error=F}

library(tidyverse)
library(gtsummary)
library(survey)
library(RColorBrewer)
library(sf)
library(ggupset)
library(questionr)
library(tmap)
library(GGally)
library(ggsci)

region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")
```


# EDITADO
=======

# RESUMEN

V001 : CONGLOMERADO V022 : ESTRATO V005 : FACTOR DE PONDERACION MUJER

```{r,warning=F, message=F, error=F}

# Eliminando bases que no se usan
#rm(list=ls())

# Base de trabajo
MOV_GENERAL <- read.csv("./NewData/mov_general.csv")

df2<-MOV_GENERAL %>%
  
  mutate(
    tiposeguro = ifelse(CREDLUGAR == "H.MINSA/FFAA"|
                        CREDLUGAR == "H.ESSALUD"|
                        CREDLUGAR == "CS/POSTA MINSA"|
                        CREDLUGAR == "CS.ESSALUD", "Estado",
                        ifelse(CREDLUGAR == "OTRO/PRIVADO","Privado",NA)),
    
    
    CREDLUGAR2 = ifelse(CREDLUGAR == "H.MINSA/FFAA"|CREDLUGAR == "H.ESSALUD","Hospital",
                        ifelse(CREDLUGAR == "CS/POSTA MINSA"|CREDLUGAR == "CS.ESSALUD","CentroSalud",CREDLUGAR))
  ) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data,
            .f = ~svydesign(id =~ V001, strata =~ V022, weights=~V005, data=.x))) 

options(survey.lonely.psu="remove")

```

# DESCRIPCION DE VARIABLES

```{r}
df3<-df2 %>% 
  mutate(
    tresidencia_m = map(.x = df,
                         .f = ~svymean(~as.factor(TIPORESIDENCIA), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    tresidencia_ci = map(.x = df,
                         .f = ~svymean(~as.factor(TIPORESIDENCIA), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    housingtype = map2(.x = tresidencia_m,
                       .y = tresidencia_ci,
                       .f = ~bind_cols(.x,.y)),
    
    
    
    
    cred_m = map(.x = df,
                         .f = ~svymean(~as.factor(CREDLUGAR2), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    cred_ci = map(.x = df,
                         .f = ~svymean(~as.factor(CREDLUGAR2), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    credloc = map2(.x = cred_m,
                       .y = cred_ci,
                       .f = ~bind_cols(.x,.y)),
    
    
    
    credtipo_m = map(.x = df,
                         .f = ~svymean(~as.factor(tiposeguro), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    credtipo_ci = map(.x = df,
                         .f = ~svymean(~as.factor(tiposeguro), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    credtype = map2(.x = credtipo_m,
                       .y = credtipo_ci,
                       .f = ~bind_cols(.x,.y)),
    
    
    
    
    edu_m = map(.x = df,
                         .f = ~svymean(~as.factor(EDU_MADRE), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    edu_ci = map(.x = df,
                         .f = ~svymean(~as.factor(EDU_MADRE), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    edumadre = map2(.x = edu_m,
                    .y = edu_ci,
                    .f = ~bind_cols(.x,.y)),
    
    
    
    etnia_m = map(.x = df,
                         .f = ~svymean(~as.factor(ETNIA_MADRE), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    etnia_ci = map(.x = df,
                         .f = ~svymean(~as.factor(ETNIA_MADRE), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    etnia = map2(.x = etnia_m,
                 .y = etnia_ci,
                 .f = ~bind_cols(.x,.y)),
    
    
    
    
    income_m = map(.x = df,
                         .f = ~svymean(~as.factor(INDICERIQUEZA), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           as.vector() %>% 
                           as.data.frame() %>% 
                           mutate("prop" = as.numeric(.)) %>% 
                           select(-.)),
    
    income_ci = map(.x = df,
                         .f = ~svymean(~as.factor(INDICERIQUEZA), design = .x, na.rm = T, vartype = c("se","ci")) %>% 
                           confint() %>% 
                           as.data.frame() %>% 
                           rownames_to_column(var = "var")),
    
    income = map2(.x = income_m,
                 .y = income_ci,
                 .f = ~bind_cols(.x,.y))

  ) 


```


```{r}
housing<-
  df3 %>% 
  select(ANIO,housingtype) %>% 
  unnest(cols = c("housingtype")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                             variable = "housing")

creloc<-
  df3 %>% 
  select(ANIO,credloc) %>% 
  unnest(cols = c("credloc")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                         variable = "credloc")

credtype<-
  df3 %>% 
  select(ANIO,credtype) %>% 
  unnest(cols = c("credtype")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                          variable = "credtype")

edumadre<-
  df3 %>% 
  select(ANIO,edumadre) %>% 
  unnest(cols = c("edumadre")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                          variable = "edumadre")

etnia<-
  df3 %>% 
  select(ANIO,etnia) %>% 
  unnest(cols = c("etnia")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                       variable="etnia")

income<-
  df3 %>% 
  select(ANIO,income) %>% 
  unnest(cols = c("income")) %>% mutate(prop = round(prop*100),
                                             `2.5 %`=round(`2.5 %`*100),
                                             `97.5 %`=round(`97.5 %`*100),
                                        variable = "income")


descriptivo<-
  bind_rows(housing,credtype,creloc,edumadre,income,etnia) %>% 
  select(ANIO,prop,`2.5 %`,`97.5 %`,var,variable)
  
```

#DOSIS 11 ANIOS

Primeras Dosis de las 4 vacunas en los 11 anios de estudio.

```{r, warning=F, message=F, error=F}
ptv1<-
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45PV1_1, design =.x, na.rm = T)),
    
    ptv1=map(.x = df,
             .f =~svyciprop(~S45PV1_1, design =.x, na.rm = T)),
    
     ptv1ci = map(.x = ptv1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(ptv1ci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "ptv1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)


  
influ1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45IF1_1, design =.x, na.rm = T)),
    
    influ1=map(.x = df,
             .f =~svyciprop(~S45IF1_1, design =.x, na.rm = T)),
    
     influci = map(.x = influ1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(influci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "influ1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



neumo1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45NM1_1, design =.x, na.rm = T)),
    
    nuemo1=map(.x = df,
             .f =~svyciprop(~S45NM1_1, design =.x, na.rm = T)),
    
     neumoci = map(.x = nuemo1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(neumoci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "neumo1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



rota1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45RT1_1, design =.x, na.rm = T)),
    
    rota1=map(.x = df,
             .f =~svyciprop(~S45RT1_1, design =.x, na.rm = T)),
    
     rotaci = map(.x = rota1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(rotaci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "rota1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)




 rbind(ptv1,neumo1,influ1,rota1) %>% 
   as.data.frame() %>% 
   mutate(
     vacunatipo = case_when(vacunatipo == "ptv1" ~ "PTV",
                            vacunatipo == "neumo1" ~ "NEUMO",
                            vacunatipo == "influ1" ~ "INFLU",
                            vacunatipo == "rota1" ~ "ROTA")
   ) %>% 
  ungroup() %>%
  ggplot(aes(x = ANIO, y = vacuna*100,
             ymin = ci_l*100, ymax = ci_h*100, group = vacunatipo))+

  geom_line(aes(color = vacunatipo), size = 1.5) +
  geom_ribbon(aes(fill = vacunatipo), alpha = 0.1)+
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+

  xlab("Years") +
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
  ylab("Prop. %")+

  geom_hline(aes(yintercept = 85), linetype = "dashed") +
   
   theme_bw()+

  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )
             
#ggsave("Fig1.png",width = 8, height = 6, dpi = 300)           


coverage1 <-  rbind(ptv1,neumo1,influ1,rota1)

coverage1 <- 
  coverage1 %>% 
  mutate(
    across(.cols = c(ci_l,ci_h,vacuna), .fns = ~round(.x,2)*100),
    estimate = paste0(vacuna," ","(",ci_l,"-",ci_h,")"),
    vacunatipo = case_when(vacunatipo == "ptv1" ~ "Pentavalent",
                           vacunatipo == "rota1" ~ "Rotavirus",
                           vacunatipo == "neumo1" ~ "Pneumo",
                           vacunatipo == "influ1" ~ "Influenza")
  )
 
```

# ggupset DE LAS 3 DOSIS DE VACUNACION 

```{r}
#rm(list=ls())

# Base de trabajo
MOV_GENERAL <- read.csv("./NewData/mov_general.csv")

MOV_GENERAL<-MOV_GENERAL %>%
  
  
  mutate(
    
    PTVcompleta  = ifelse(S45PV1_1 ==1 & S45PV2_1 == 1 & S45PV3_1 == 1,1,0),
    NEUMOcompleta = ifelse(S45NM1_1==1 & S45NM2_1==1 & S45NM3_1==1,1,0),
    INLFUcompelta = ifelse(S45IF1_1==1 & S45IF2_1==1,1,0),
    ROTAcompleta = ifelse(S45RT1_1 ==1 & S45RT1_1==1,1,0),
    
  
         
         vacuna5 = ifelse(PTVcompleta==1 & ROTAcompleta == 1 & INLFUcompelta==1 & NEUMOcompleta == 1, list(c("PTVc","ROTAc","INFLUc","NEUMOc")),
                          ifelse(PTVcompleta==0 & ROTAcompleta == 0 & INLFUcompelta==0 & NEUMOcompleta == 0, list(c(NA)),
                                 ifelse(PTVcompleta==1 & ROTAcompleta == 1 & INLFUcompelta==1 & NEUMOcompleta == 0, list(c("PTVc","ROTAc","INFLUc")),
                                        ifelse(PTVcompleta==0 & ROTAcompleta == 1 & INLFUcompelta==1 & NEUMOcompleta == 1, list(c("ROTAc","INFLUc","NEUMOc")),
                                               ifelse(PTVcompleta==1 & ROTAcompleta == 0 & INLFUcompelta==1 & NEUMOcompleta == 1, list(c("PTVc","INFLUc","NEUMOc")),
                                                      ifelse(PTVcompleta==1 & ROTAcompleta == 1 & INLFUcompelta==0 & NEUMOcompleta == 1, list(c("PTVc","ROTAc","INFLUc")),
                                                             ifelse(PTVcompleta==1 & ROTAcompleta == 1 & INLFUcompelta==0 & NEUMOcompleta == 0,list(c("PTVc","ROTAc")),
                                                                    ifelse(PTVcompleta==0 & ROTAcompleta == 0 & INLFUcompelta==1 & NEUMOcompleta == 1,list(c("INFLUc","NEUMOc")),
                                                                           ifelse(PTVcompleta==1 & ROTAcompleta == 0 & INLFUcompelta==0 & NEUMOcompleta == 1,list(c("PTVc","NEUMOc")),
                                                                                  ifelse(PTVcompleta==0 & ROTAcompleta == 1 & INLFUcompelta==0 & NEUMOcompleta == 1,list(c("ROTAc","NEUMOc")),
                                                                                         ifelse(PTVcompleta==1 & ROTAcompleta == 0 & INLFUcompelta==1 & NEUMOcompleta == 0,list(c("PTVc","INFLUc")),
                                                                                                ifelse(PTVcompleta==0 & ROTAcompleta == 1 & INLFUcompelta==1 & NEUMOcompleta == 0,list(c("ROTAc","INFLUc")),
                                                                                                       ifelse(PTVcompleta==1 & ROTAcompleta == 0 & INLFUcompelta==0 & NEUMOcompleta == 0,list(c("PTVc")),
                                                                                                              ifelse(PTVcompleta==0 & ROTAcompleta == 1 & INLFUcompelta==0 & NEUMOcompleta == 0,list(c("ROTAc")),
                                                                                                                     ifelse(PTVcompleta==0 & ROTAcompleta == 0 & INLFUcompelta==1 & NEUMOcompleta == 0,list(c("INFLUc")),
                                                                                                                ifelse(PTVcompleta==0 & ROTAcompleta == 0 & INLFUcompelta==0 & NEUMOcompleta == 1,list(c("NEUMOc")),NA)))))))))))))))),
         
         
         
         year = ANIO)


```


```{r}
figura2a<-
  ggplot(MOV_GENERAL) +
  aes(x = vacuna5)+
  geom_bar(fill = "#506D84")+
  geom_text(stat='count', aes(label=after_stat(count)), vjust=-1, size = 3) +
  theme_minimal()+
  theme(
    panel.grid = element_blank()
  )+
  labs(x = "Complete doses", y = "")+
  scale_x_upset(n_intersections= 13) +
  scale_y_continuous(breaks = NULL)

#ggsave("Fig2a.png", width = 10, height = 6)



figura2b<-
MOV_GENERAL %>% 
  select(DEPARTAMEN,PTVcompleta:ROTAcompleta) %>% 
  pivot_longer(cols = c(PTVcompleta:ROTAcompleta), names_to = "vacuna") %>% 
  filter(value == 0) %>% 
  group_by(DEPARTAMEN,vacuna) %>% 
  summarise(numero = n()) %>% 
  mutate(vacuna = recode(vacuna,"INLFUcompelta"="Influenza vaccine",
                         "NEUMOcompleta"="Pneumococcal vaccine",
                         "PTVcompleta"="Pentavalent vaccine",
                         "ROTAcompleta"="Rotavirus vaccine"),
         percent = round((numero/sum(numero)*100)),
         vacuna = factor(vacuna, levels = c("Influenza vaccine","Pneumococcal vaccine",
                                             "Rotavirus vaccine","Pentavalent vaccine")))%>% 

  left_join(region_shape) %>% 
  st_as_sf() %>% 
  
  ggplot()+
  geom_sf(aes(fill = percent), col = "#b6cfde") +
   scale_fill_gradient(high  ="#0C6291", low = "#e5e5e5")+
   #scale_color_gradient(high ="#e5e5e5", low = "#e5e5e5") +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 25,title.position = "top", direction = "horizontal"))+
  facet_wrap(~vacuna, nrow = 1)+
  theme_minimal()+
  labs(color = "", fill = "% of non-vaccinations by regions")+
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 9, face = "bold"),
    legend.text = element_text(size = 8),
    panel.grid = element_blank(),
    strip.text = element_text(size = 9, face = "bold"),
    axis.text = element_text(size = 5))

#ggsave("figura2b.png", width = 8, height = 4)
  

figura2<-cowplot::plot_grid(figura2a,figura2b, ncol = 1, labels = c("a","b"), rel_heights = c(0.6,0.4))

ggsave("figura2.png", height = 9, width = 8.5, dpi = 300)
```



# PROPORCION POR CRED

Se incluyeron para el estudio los <5 anios que tenian CRED o SEGURO. En el grafico se muestra la evolucion de las OPV por vacuna en funcion de si tenian CRED o no (los que no tienen, es porque solo cuentan con seguro).  

```{r, echo=F, warning=F, message=F, error=F}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  #full_join(region_shape, by="DEPARTAMEN") %>%

  mutate(ANIO = as.character(ANIO))



ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = CRED)) +

  geom_col( position = position_dodge(width = 1), width = 0.8, alpha = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 1),

                width = 0.25) +


  scale_fill_manual(values = c("#9E5797","#6570C6")) +

  facet_wrap(facets = ~ANIO, ncol = 4, scale = "free_x") +

  theme_minimal() +

  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))

```

# PROPORCION POR LUGAR DONDE TIENE CRED

```{r, echo=F, warning=F, message=F, error=F, fig.height= 8, fig.width= 13}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~CREDLUGAR2, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTv") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~CREDLUGAR2, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~CREDLUGAR2, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~CREDLUGAR2, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  #full_join(region_shape, by="DEPARTAMEN") %>%

  mutate(ANIO = as.character(ANIO))


ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = CREDLUGAR2)) +

  geom_col( position = position_dodge(width = 0.85), width = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 0.85),

                width = 0.12) +


  scale_fill_manual(values = c("#5D9C7C","#4F7D95","#9CB0A4","#4F97BF","#0090B7","#394B41")) +

  facet_wrap(facets = ~ANIO, ncol = 3, scales  = "free_x") +

  theme_minimal() +
  
  #coord_flip() + 


  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))

#ggsave("cred.png",width = 18)



```

# CRED (ORIGEN)
```{r}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~tiposeguro, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~tiposeguro, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~tiposeguro, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~tiposeguro, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  #full_join(region_shape, by="DEPARTAMEN") %>%

  mutate(ANIO = as.character(ANIO))



ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = tiposeguro)) +

  geom_col( position = position_dodge(width = 1), width = 0.8, alpha = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 1),

                width = 0.25) +


  scale_fill_manual(values = c("#9E5797","#6570C6")) +

  facet_wrap(facets = ~ANIO, ncol = 4, scale = "free_x") +

  theme_minimal() +

  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))

```

# TIPO DE RESIDENCIA

```{r, echo=F, warning=F, message=F, error=F}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~TIPORESIDENCIA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~TIPORESIDENCIA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~TIPORESIDENCIA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~TIPORESIDENCIA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  # full_join(region_shape, by="DEPARTAMEN") %>%

  mutate(ANIO = as.character(ANIO))




ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = TIPORESIDENCIA)) +

  geom_col( position = position_dodge(width = 1), width = 0.8, alpha = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 1),

                width = 0.25) +


  scale_fill_manual(values = c("#9E5797","#6570C6")) +

  facet_wrap(facets = ~ANIO, ncol = 4, scale = "free_x") +

  theme_minimal() +

  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))

```

# EDUCACION DE LA MADRE

```{r, echo=F, warning=F, message=F, error=F}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~EDU_MADRE, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~EDU_MADRE, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~EDU_MADRE, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~EDU_MADRE, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  # full_join(region_shape, by="DEPARTAMEN") %>%
  
  group_by(ANIO,vacunatipo) %>% 

  mutate(ANIO = as.character(ANIO),
         EDUMADRE = case_when(EDU_MADRE == "sin educ" ~ 0,
                                         EDU_MADRE == "primaria" ~ 1,
                                         EDU_MADRE == "secundaria" ~ 2,
                                         EDU_MADRE == "superior" ~ 3),
         
         EDUMADRE = as.factor(EDUMADRE)) 




ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = EDUMADRE)) +

  geom_col( position = position_dodge(width = 0.85), width = 0.8, alpha = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 0.85),

                width = 0.25) +


  scale_fill_manual(values = c("#5D9C7C","#4F7D95","#9CB0A4","#4F97BF"),
                    labels = c("No education","Primary school","High school","Superiior education")) +

  facet_wrap(facets = ~ANIO, ncol = 4, scale = "free_x") +

  theme_minimal() +

  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))



```

# INDICE DE RIQUEZA

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 8}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~INDICERIQUEZA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~INDICERIQUEZA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~INDICERIQUEZA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  # full_join(region_shape, by="DEPARTAMEN") %>%
  
  group_by(ANIO,vacunatipo) %>% 

  mutate(ANIO = as.character(ANIO)) 
# 
# 
ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = INDICERIQUEZA)) +

  geom_col( position = position_dodge(width = 0.85), width = 0.8, alpha = 0.8) +

  geom_errorbar(aes(ymin = ci_l,
                    ymax = ci_u),

                position = position_dodge(width = 0.85),

                width = 0.25) +


  scale_fill_manual(values = c("#5D9C7C","#4F7D95","#9CB0A4","#4F97BF","#394B41"),
                    labels = c("1st","2nd","3rd","4th","5th")) +

  facet_wrap(facets = ~ANIO, ncol = 4, scale = "free_x") +

  theme_minimal() +

  theme(axis.text.x = element_text(size = 7),
        strip.text = element_text(size = 9))



```



# REGION

## EDUCACION MADRE

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 15}
df3<-df2 %>%

  mutate(
    ptv = map(.x = df ,
                 .f = ~svyby(~MOV_PTV_e1, by=~CRED+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV") %>%
                select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),

    neumo = map(.x = df ,
                 .f = ~svyby(~MOV_NEUMO_e1, by=~CRED+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO") %>%
                  select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),

    influ = map(.x = df ,
                 .f = ~svyby(~MOV_INFLU_e1, by=~CRED+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                  mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU") %>%
                  select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),

    rota = map(.x = df ,
                 .f = ~svyby(~MOV_ROTA_e1, by=~CRED+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%

                 mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>%
                 select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%

  select(-data) %>%

  mutate(

  pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
  pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),

  total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),

) %>%

  select(ANIO,total) %>%

  ungroup() %>%

  unnest(cols = c(total)) %>%

  full_join(region_shape, by="DEPARTAMEN") %>%

  mutate(ANIO = as.character(ANIO))



# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = as.factor(EDU_MADRE))) +
#
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#
#   geom_errorbar(aes(ymin = ci_l,
#                     ymax = ci_u),
#
#                 position = position_dodge(width = 1),
#
#                 width = 0.25) +
#
#
#   scale_fill_brewer(palette = 9) +
#
#   theme_bw()


ggplot(data = st_as_sf(df3) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +

  geom_sf(aes(fill = vacuna_cut)) +

  viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  +


  facet_wrap(facets = ~CRED + vacunatipo, nrow = 2) +

  theme_bw()


```

## EDAD MADRE

```{r, echo=F, warning=F, message=F, error=F, fig.width= 10, fig.height= 10}
# PTV<-svyby(~MOV_PTV_e1_2, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) %>% full_join(region_shape, by = c("DEPARTAMEN"))
# 
# 
# ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
#                                        vacuna_cut = cut_interval(vacuna, n = 6))) +
#   
#   geom_sf(aes(fill = vacuna_cut)) +
#   
#   viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
#   
#   
#   facet_wrap(facets = ~EDAD_MADRE + vacunatipo, nrow = 2) +
#   
#   theme_bw()
```





## OPV EN LOS 11 ANIOS

```{r,warning=F, message=F, error=F}

# Eliminando bases que no se usan
#rm(list=ls())

# Base de trabajo
MOV_GENERAL <- read.csv("./NewData/mov_general.csv")

df2<-MOV_GENERAL %>%
  
  filter((CRED == "Si" | SEGURO == "Si")) %>% 
  
  mutate(
    tiposeguro = ifelse(CREDLUGAR == "H.MINSA/FFAA"|
                        CREDLUGAR == "H.ESSALUD"|
                        CREDLUGAR == "CS/POSTA MINSA"|
                        CREDLUGAR == "CS.ESSALUD", "Estado",
                        ifelse(CREDLUGAR == "OTRO/PRIVADO","Privado",NA)),
    
    
    CREDLUGAR2 = ifelse(CREDLUGAR == "H.MINSA/FFAA"|CREDLUGAR == "H.ESSALUD","Hospital",
                        ifelse(CREDLUGAR == "CS/POSTA MINSA"|CREDLUGAR == "CS.ESSALUD","CentroSalud",CREDLUGAR))
  ) %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data,
            .f = ~svydesign(id =~ V001, strata =~ V022, weights=~V005, data=.x))) 

options(survey.lonely.psu="remove")

```


```{r, warning=F, message=F, error=F}
ptv1<-
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~MOV_PTV_e1, design =.x, na.rm = T)),
    
    ptv1=map(.x = df,
             .f =~svyciprop(~MOV_PTV_e1, design =.x, na.rm = T)),
    
     ptv1ci = map(.x = ptv1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(ptv1ci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "ptv1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)
  
  
influ1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~MOV_INFLU_e1, design =.x, na.rm = T)),
    
    influ1=map(.x = df,
             .f =~svyciprop(~MOV_INFLU_e1, design =.x, na.rm = T)),
    
     influci = map(.x = influ1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(influci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "influ1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)
  

neumo1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~MOV_NEUMO_e1, design =.x, na.rm = T)),
    
    nuemo1=map(.x = df,
             .f =~svyciprop(~MOV_NEUMO_e1, design =.x, na.rm = T)),
    
     neumoci = map(.x = nuemo1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(neumoci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "neumo1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



rota1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~MOV_ROTA_e1, design =.x, na.rm = T)),
    
    rota1=map(.x = df,
             .f =~svyciprop(~MOV_ROTA_e1, design =.x, na.rm = T)),
    
     rotaci = map(.x = rota1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(rotaci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "rota1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



rbind(ptv1,neumo1,influ1,rota1) %>% 
   as.data.frame() %>% 
   mutate(
     vacunatipo = case_when(vacunatipo == "ptv1" ~ "PTV",
                            vacunatipo == "neumo1" ~ "NEUMO",
                            vacunatipo == "influ1" ~ "INFLU",
                            vacunatipo == "rota1" ~ "ROTA")
   ) %>% 
  ggplot(aes(x = ANIO, y = vacuna*100, 
             ymin = ci_l*100, ymax = ci_h*100, group = vacunatipo))+
  
  geom_line(aes(color = vacunatipo), size = 1.5) +
  geom_ribbon(aes(fill = vacunatipo), alpha = 0.1)+
  
  scale_color_npg(alpha = 0.7)+
  scale_fill_npg()+

  xlab("Years") +
  scale_x_continuous(expand = c(0, 0), breaks = c(2010:2020), limits = c(2010,2020.1))+
  ylab("Prop. %")+
  
  theme_bw()+
  
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  ) 


#ggsave("Fig3.png",width = 8, height = 6, dpi = 300)  


mov <- rbind(ptv1,neumo1,influ1,rota1)

mov <- mov %>% 
  mutate(
    across(.cols = c(ci_l,ci_h,vacuna), .fns = ~round(.x,2)*100),
    estimate = paste0(vacuna," ","(",ci_l,"-",ci_h,")"),
    vacunatipo = case_when(vacunatipo == "ptv1" ~ "Pentavalent",
                           vacunatipo == "rota1" ~ "Rotavirus",
                           vacunatipo == "neumo1" ~ "Pneumo",
                           vacunatipo == "influ1" ~ "Influenza")
  )

```

# REGION / DOSIS

Dosis completas para las 4 vacunas en los 11 anios de estudio, por region.

```{r, warning=F, message=F, error=F}
covertura.region<-
  df2 %>%
  mutate(
    
    ptv1=map(.x = df,
        .f =~svyby(~S45PV1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
          mutate(vacuna = S45PV1_1,vacunatipo = "PTV") %>%
          select(-`se.as.numeric(S45PV1_1)`,-S45PV1_1)),
    
    ptv2=map(.x = df,
             .f =~svyby(~S45PV2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45PV2_1,vacunatipo = "PTV") %>%
               select(-`se.as.numeric(S45PV2_1)`,-S45PV2_1)),
    
    ptv3=map(.x = df,
             .f =~svyby(~S45PV3_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45PV3_1,vacunatipo = "PTV") %>%
               select(-`se.as.numeric(S45PV3_1)`,-S45PV3_1)),
    
    
    neumo1=map(.x = df,
             .f =~svyby(~S45NM1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM1_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM1_1)`,-S45NM1_1)),
    
    neumo2=map(.x = df,
             .f =~svyby(~S45NM2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM2_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM2_1)`,-S45NM2_1)),
    
    neumo3=map(.x = df,
             .f =~svyby(~S45NM3_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM3_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM3_1)`,-S45NM3_1)),
    
    
    
    influ1=map(.x = df,
             .f =~svyby(~S45IF1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45IF1_1,vacunatipo = "INFLU") %>%
               select(-`se.as.numeric(S45IF1_1)`,-S45IF1_1)),
    
    influ2=map(.x = df,
             .f =~svyby(~S45IF2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45IF2_1,vacunatipo = "INFLU") %>%
               select(-`se.as.numeric(S45IF2_1)`,-S45IF2_1)),
    
    
    
    
    rota1=map(.x = df,
             .f =~svyby(~S45RT1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45RT1_1,vacunatipo = "ROTA") %>%
               select(-`se.as.numeric(S45RT1_1)`,-S45RT1_1)),
    
    rota2=map(.x = df,
             .f =~svyby(~S45RT2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45RT2_1,vacunatipo = "ROTA") %>%
               select(-`se.as.numeric(S45RT2_1)`,-S45RT2_1)),
    
  
    )

```

## Graficos 

```{r,fig.height= 8, fig.width= 13, warning=F, message=F, error=F}
a<-
  covertura.region %>%
  pivot_longer(cols = c(ptv1:ptv3), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C","#A98B98"), 
                     labels = c("1º dose","2º dose","3º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN) 

cowplot::plot_grid(a,labels = c("a"))
ggsave("SFigure1a.png", width = 18, height = 10, dpi = 300)


b<-
  covertura.region %>%
  pivot_longer(cols = c(neumo1:neumo3), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C","#A98B98"), 
                     labels = c("1º dose","2º dose","3º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

cowplot::plot_grid(b,labels = c("b"))
 ggsave("SFigure1b.png", width = 18, height = 10, dpi = 300)



 c<-
   covertura.region %>%
  pivot_longer(cols = c(influ1:influ2), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C"), 
                     labels = c("1º dose","2º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

 cowplot::plot_grid(c,labels = c("c"))
 ggsave("SFigure1c.png", width = 18, height = 10, dpi = 300)



 d<-
   covertura.region %>%
  pivot_longer(cols = c(rota1:rota2), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C"), 
                     labels = c("1º dose","2º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

 cowplot::plot_grid(d,labels = c("d"))
 ggsave("SFigure1d.png", width = 18, height = 10, dpi = 300)
```

