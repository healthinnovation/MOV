---
title: "MOV 1"
author: "jose"
date: "18/6/2021"
output: html_document
---

# Bases
```{r}
library(tidyverse)
library(gtsummary)
library(survey)

NINIO <- read.csv("ENDES/DIT.csv", sep = ";" )
NINIO2 <- read.csv("ENDES/REC41.csv", sep = ";" )
MUJER1 <- read.csv("ENDES/REC42.csv", sep = ";" )
VACUNA1 <- read.csv("ENDES/REC43.csv", sep = ";" )
VACUNA2 <- read.csv("ENDES/REC95.csv", sep = ";" )
HOGAR1 <- read.csv("ENDES/RECH0.csv", sep = ";" )
HOGAR_MADRE <- read.csv("ENDES/RECH1.csv", sep = ";" )
VIVIENDA1 <- read.csv("ENDES/RECH23.csv", sep = ";" )
MUJER2<- read.csv("ENDES/REC0111.csv", sep = ";" )
```

# PRE UNION
```{r}
# BD principales

VACUNA1 <- VACUNA1 %>% select(CASEID,H1:H10) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

VACUNA2 <- VACUNA2 %>% select(CASEID,S466,S466B,S45D4:S45IF2Y) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))


# Otras BD
NINIO <- NINIO %>% select(CASEID,QI478,BIDX) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

NINIO2 <- NINIO2 %>% select(CASEID,M15) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

MUJER1<- MUJER1 %>% select(CASEID,V481:V481X) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

MUJER2<-MUJER2 %>% select(CASEID,V001,V002,V005,V012,V022,V023,V024,V025,V101,V102,V106,V131,V190) %>% mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

HOGAR_MADRE<-HOGAR_MADRE %>% select(HHID,HVIDX,QH25A,HV122)


# Caracteristicas por Hogar

HOGAR1<- HOGAR1 %>% select(HHID,HV003,HV000:HV002A,HV005,HV022,HV007,HV008,HV021,HV023:HV026) 
VIVIENDA1<- VIVIENDA1 %>% select(HHID,HV270)
#


```

# UNION

```{r}

## BD intermedias
VACUNA_2020 <- VACUNA1 %>% full_join(VACUNA2, by =c("HHID","CASEID")) 

NINIO_2020 <- NINIO %>% left_join(NINIO2, by = c("HHID","CASEID"))

MUJER_2021 <- MUJER1 %>% 
  
  left_join(MUJER2, by = c("HHID","CASEID")) %>%
  
  left_join(HOGAR_MADRE, by = "HHID")


## BD final
MOV2020<- VACUNA_2020 %>% 
  
  left_join(NINIO_2020, by = c("HHID","CASEID")) %>% 
  
  left_join(MUJER_2021, by = c("HHID","CASEID")) %>% group_by(CASEID) %>% slice(1) %>% filter(!is.na(H1)) %>% ungroup()

```

# EDITADO



```{r}
MOV2020<-MOV2020 %>%
  
  select(H1,H2,H3,H4,H5,H6,H7,H8,H9,H10,
         S45D4,S45D5,S45P4,S45P5,S45B0,S45B1,
         S45B2,S45B3,S45F1,S45F2,S45F3,S45PV1,
         S45PV2,S45PV3,S45TT,S45SP1,S45SP2,S45SR,
         S45NM1,S45NM2,S45NM3,S45RT1,S45RT2,S45IF1,
         S45IF2,S466,S466B,V001,V005,V012,V022,V023,
         V024,V025,V102,V106,V131,
         QI478,V481:V481X,V190,V022) %>% 
  
        # cATEGORIAS DE RESPUESTA A LA VACUNACION
  mutate(
    across(H1:S45IF2,~factor(.x, levels = c(0,1,2,3,8), labels = c("No/NoSabe","Tarjeta","Madre",
                                                                        "Tarjeta","No/NoSabe"))),
    
    
    # across(H1:S45IF2,~factor(.x, levels = c(0,1,2,3,8), labels = c("No","FechaTarjeta","Madre",
    #                                                                     "MarcaTarjeta","NoSabe"))),
    
         
         
         
         CRED = as.factor(ifelse(S466==0,"No",
                       ifelse(S466==1,"Si","No sabe"))),
         
         
         CREDLUGAR = factor(S466B, levels = c(21,22,23,24,
                                              25,26,27,31,
                                              32,41,42,96), labels = c("H.MINSA","H.ESSALUD","H.FFAA",
                                                                 "CS.MINSA","PUESTOMINSA","CS.ESSALUD",
                                                                 "H.MUNI","CLINICA","MEDICO","CLINICA/ONG",
                                                                 "H.IGLESIA","OTRO")),
         
         
         
         TIPORESIDENCIA = ifelse(V025==1,"URBANO","RURAL"),
         
         
         LUGARRESIDENCIA = factor(V102, levels = c(0,1,2,3), labels = c("Gran ciudad","Peq ciudad",
                                                                        "Pueblo","Campo")),
         
         
         REGION = factor(V024, levels = c(1:25), labels = c("amazonas","ancash","apurimac","arequipa","ayacucho",
                                                            "cajamarca","callao","cusco","huancavelica","huanuco",
                                                            "ica","junin","la libertad","lambayeque","lima",
                                                            "loreto","madre de dios","moquegua","pasco","piura",
                                                            "puno","san martin","tacna","tumbes","ucayali")),
         
         
         
         EDU_MADRE = factor(V106, levels = c(0,1,2,3), labels = c("Sin educ","primaria","secundaria","superior")),
         
         
         ETNIA_MADRE = factor(V131, levels = c(1:12), labels = c("quechua","aimara","ashaninka","awajun",
                                                                 "shipibo","shawi","matsigenka","achuar",
                                                                 "Otro","castellano","portugues","Otro extranjero")),
         
         
         
         EDAD_ANIOS = round((QI478/12),0),
         
         SEGURO = factor(V481, levels = c(0,1), labels = c("No","Si")),
         
         EDAD_MADRE = V012,
         
         INDICERIQUEZA = V190) 
  


```

RESUMEN 

V001 : CONGLOMERADO
V022 : ESTRATO
V005 : FACTOR DE PONDERACION MUJER

```{r}
df <- svydesign(id =~ V001, strata =~ V022, weights=~ V005, data=MOV2020) 


options(survey.lonely.psu="remove")
# options(survey.adjust.domain.lonely=TRUE)
# options(survey.lonely.psu="adjust")


BCG<-svyby(~H2,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H2,vacunatipo = "BCG") %>% select(-`se.as.numeric(H2)`,-H2)
DPT1<-svyby(~H3,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H3,vacunatipo = "DPT1") %>% select(-`se.as.numeric(H3)`,-H3)
POLIO1<-svyby(~H4,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H4,vacunatipo = "POLIO1") %>% select(-`se.as.numeric(H4)`,-H4)
DPT2<-svyby(~H5,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H5,vacunatipo = "DPT2") %>% select(-`se.as.numeric(H5)`,-H5)
POLIO2<-svyby(~H6,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H6,vacunatipo = "POLIO2") %>% select(-`se.as.numeric(H6)`,-H6)
DPT3<-svyby(~H7,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H7,vacunatipo = "DPT3") %>% select(-`se.as.numeric(H7)`,-H7)
POLIO3<-svyby(~H8,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H8,vacunatipo = "POLIO3") %>% select(-`se.as.numeric(H8)`,-H8)
SARAMPION<-svyby(~H9,by=~V024,design =df,FUN=svyciprop, vartype=c('se','ci')) %>% mutate(vacuna = H9,vacunatipo = "SARAMPION") %>% select(-`se.as.numeric(H9)`,-H9)


df2 <- bind_rows(BCG,DPT1,POLIO1,DPT2,POLIO2,DPT3,POLIO3,SARAMPION)


gg<-function(df2){
  
  ggplot(data = df2, mapping = aes(x = as.factor(V024),y = vacuna, ymin = ci_l, ymax = ci_u)) +
  
  
  geom_pointrange() +
  
  geom_linerange(aes(ymin=ci_l, ymax=ci_u),width=0.5,cex=1) +
  
  geom_hline(yintercept = 0.95, linetype = 2) + 
  
  theme_minimal() + 
  
  coord_flip() }

  
grafico<-df2 %>% group_by(vacunatipo) %>% nest() %>% mutate(grafico = map(.x =data, .f = ~gg(.x)))


cowplot::plot_grid(plotlist = grafico$grafico)
```

