---
title: "MOV 1"
author: "jose"
date: "18/6/2021"
output:
  html_document:
    code_folding: hide
    fig_height: 6
    fig_width: 9
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

# Bases

```{r, echo=F, warning=F, message=F, error=F}
library(tidyverse)
library(gtsummary)
library(survey)
library(RColorBrewer)
library(sf)

region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")
```


# EDITADO
=======

# EDITAR BASES

```{r,warning=F, message=F, error=F}
prep.data <-function(MOV2020){ MOV2020 %>%
  
  select(CASEID,
         # H1,H2,H3,H4,H5,H6,H7,H8,H9,H10,
         # S45D4,S45D5,S45P4,S45P5,S45B0,S45B1,
         # S45B2,S45B3,S45TT,S45SP1,S45SP2,S45SR,
         S45F1,S45F2,S45F3,
         S45PV1,S45PV2,S45PV3,
         S45NM1,S45NM2,S45NM3,
         S45RT1,S45RT2,
         S45IF1,S45IF2,
         
         S466,S466B,V001,V005,V012,V022,V023,
         V024,V025,V102,V106,V131,
         V481:V481X,V190,V022,ANIO) %>% 
  
  
  
  
        # cATEGORIAS DE RESPUESTA A LA VACUNACION
  mutate(
    
        # across(S45F1:S45IF2,~ifelse(.x == 0|.x == 8,0, # 0: No, 8: No sabe
        #                          ifelse(.x == 1|.x == 3,1,2))),# 1: Tarjeta fecha, # 3: Marca tarjeta
        
        
        across(S45F1:S45IF2,~ifelse(.x == 0|.x == 8,0,1)),# 1: Tarjeta fecha, # 3: Marca tarjeta

    
    
         
         CRED = as.factor(ifelse(S466==0 | S466 == 8,"No","Si")),
        
        
         
         S466B = ifelse(is.na(S466B),99,S466B),
         CREDLUGAR = factor(S466B, levels = c(21,22,23,24,
                                              25,26,27,31,
                                              32,41,42,96,99), labels = c("H.MINSA/FFAA","H.ESSALUD","H.MINSA/FFAA",
                                                                 "CS/POSTA MINSA","CS/POSTA MINSA","CS.ESSALUD",
                                                                 "OTRO/PRIVADO","OTRO/PRIVADO","OTRO/PRIVADO","OTRO/PRIVADO",
                                                                 "OTRO/PRIVADO","OTRO/PRIVADO","NoCRED")),
         
        
         
         
         TIPORESIDENCIA = ifelse(V102==1,"URBANO","RURAL"),
         
         
         
         
         
         DEPARTAMEN = factor(V024, levels = c(1:25), labels = c("AMAZONAS","ANCASH","APURIMAC","AREQUIPA","AYACUCHO",
                                                            "CAJAMARCA","CALLAO","CUSCO","HUANCAVELICA","HUANUCO",
                                                            "ICA","JUNIN","LA LIBERTAD","LAMBAYEQUE","LIMA",
                                                            "LORETO","MADRE DE DIOS","MOQUEGUA","PASCO","PIURA",
                                                            "PUNO","SAN MARTIN","TACNA","TUMBES","UCAYALI")),
         
         
         
         EDU_MADRE = as.factor(factor(V106, levels = c(0,1,2,3), labels = c("sin educ","primaria","secundaria","superior"))),
         
         
         ETNIA_MADRE = factor(V131, levels = c(1:12), labels = c("quechua","aimara","ashaninka","awajun",
                                                                 "shipibo","shawi","matsigenka","achuar",
                                                                 "Otro","castellano","portugues","Otro extranjero")),
         
         
         
         #EDAD_ANIOS = round((QI478/12),0),
         
         SEGURO = factor(V481, levels = c(0,1), labels = c("No","Si")),
         
         EDAD_MADRE = ifelse(V012<18,"< 18 a",
                             ifelse(V012>=18&V012<30,"18-30 a",
                                    ifelse(V012>=30&V012<40,"30 a 40",
                                           ifelse(V012>=40,"40 a mas",NA)))),
         
         INDICERIQUEZA = factor(V190, levels = c(1:5), labels = c("1ro","2do","3ro","4to","5to")),
    
    
        V005 = V005/1000000) %>% 
  
  
  fastDummies::dummy_cols(select_columns = c("S45F1","S45F2","S45F3", # Hib
                                             "S45PV1","S45PV2","S45PV3", #Pentavalente
                                             "S45NM1","S45NM2","S45NM3", #Neumococo
                                             "S45IF1","S45IF2", #Influenza
                                             "S45RT1","S45RT2" # Rotavirus
                                             
                                             )) %>% 
  
   # CON CRED O SEGURO
   filter((CRED == "Si" | SEGURO == "Si")) %>% 
  
  
  
  mutate( HIB_COMPLETA = as.factor(ifelse(S45F1 !=0 & S45F2 != 0 & S45F3 != 0,1,0)), # VACUNAS COMPLETAS
          PTV_COMPLETA = as.factor(ifelse(S45PV1 !=0 & S45PV2 != 0 & S45PV3 != 0,1,0)),
          NEUMO_COMPLETA = as.factor(ifelse(S45NM1 !=0 & S45NM2 != 0 & S45NM3 != 0,1,0)),
          INFLU_COMPLETA = as.factor(ifelse(S45IF1 !=0 & S45IF2 != 0,1,0)),
          ROTA_COMPLETA = as.factor(ifelse(S45RT1 !=0 & S45RT2 != 0,1,0)),
        
           ####
          ## Pentavalente
          MOV_PTV_e1 = ifelse(S45PV1==0,1,0),
          
          
          ## Neumococo 
          MOV_NEUMO_e1 = ifelse(S45NM1==0,1,0),
          
          
          ## Rotavirus (entre 2 y 4 meses, maximo 7 meses la 2da dosis)
          MOV_ROTA_e1 = ifelse(S45RT1 == 0,1,0),
          
          ## INFLUENZA (<12 m : 2 dosis, 12-35 meses:1 dosis, >36 meses: 1 dosis adulto)
          
          MOV_INFLU_e1 = ifelse(S45IF1 == 0,1,0))
          
}

```

# RESUMEN

V001 : CONGLOMERADO V022 : ESTRATO V005 : FACTOR DE PONDERACION MUJER

```{r,warning=F, message=F, error=F}

# Eliminando bases que no se usan
rm(list=ls())

# Base de trabajo
MOV_GENERAL <- read.csv("./BD.INTERMEDIAS/mov_general.csv")

df2<-MOV_GENERAL %>% 
  
  group_by(ANIO) %>% 
  nest() %>%
  mutate(
    df= map(.x = data,
            .f = ~svydesign(id =~ V001, strata =~ V022, probs=~V005, data=.x))) 


#BD en survey
# df <- svydesign(id =~ V001, strata =~ V022, probs=~V005, data=MOV2020_2) 


options(survey.lonely.psu="remove")
# options(survey.adjust.domain.lonely=TRUE)
# options(survey.lonely.psu="adjust")

```


# PROPORCION POR CRED

```{r, echo=F, warning=F, message=F, error=F}
# df3<-df2 %>% 
#   
#   mutate(
#     ptv = map(.x = df , 
#                  .f = ~svyby(~MOV_PTV_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV_COMPLETA") %>% 
#                 select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),
#     
#     neumo = map(.x = df , 
#                  .f = ~svyby(~MOV_NEUMO_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO_COMPLETA") %>% 
#                   select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),
#     
#     influ = map(.x = df , 
#                  .f = ~svyby(~MOV_INFLU_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU_COMPLETA") %>%
#                   select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),
#     
#     rota = map(.x = df , 
#                  .f = ~svyby(~MOV_ROTA_e1, by=~CRED, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                  
#                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>%
#                  select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%
#   
#   select(-data) %>% 
#   
#   mutate(
#   
#   pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#   pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#   
#   total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#   
# ) %>% 
#   
#   select(ANIO,total) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(total)) %>% 
#   
#   #full_join(region_shape, by="DEPARTAMEN") %>% 
#   
#   mutate(ANIO = as.character(ANIO))
# 
# 
# 
# ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = CRED)) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   facet_wrap(facets = ~ANIO, ncol = 5) + 
#   
#   theme_bw() +
#   
#   theme(axis.text.x = element_text(angle = 270))
```

# PROPORCION POR LUGAR DONDE TIENE CRED

```{r, echo=F, warning=F, message=F, error=F}
# df3<-df2 %>% 
#   
#   mutate(
#     ptv = map(.x = df , 
#                  .f = ~svyby(~MOV_PTV_e1, by=~CREDLUGAR, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV_COMPLETA") %>% 
#                 select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),
#     
#     neumo = map(.x = df , 
#                  .f = ~svyby(~MOV_NEUMO_e1, by=~CREDLUGAR, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO_COMPLETA") %>% 
#                   select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),
#     
#     influ = map(.x = df , 
#                  .f = ~svyby(~MOV_INFLU_e1, by=~CREDLUGAR, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU_COMPLETA") %>%
#                   select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),
#     
#     rota = map(.x = df , 
#                  .f = ~svyby(~MOV_ROTA_e1, by=~CREDLUGAR, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                  
#                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>%
#                  select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%
#   
#   select(-data) %>% 
#   
#   mutate(
#   
#   pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#   pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#   
#   total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#   
# ) %>% 
#   
#   select(ANIO,total) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(total)) %>% 
#   
#   #full_join(region_shape, by="DEPARTAMEN") %>% 
#   
#   mutate(ANIO = as.character(ANIO))
# 
# 
# ggplot(data = df3, aes(x = vacunatipo, y = vacuna, fill = CREDLUGAR)) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   facet_wrap(facets = ~ANIO, ncol = 11) + 
#   
#   theme_bw() +
#   
#   theme(axis.text.x = element_text(angle = 270))

```

# TIPO DE RESIDENCIA

```{r, echo=F, warning=F, message=F, error=F}
# df3<-df2 %>% 
#   
#   mutate(
#     ptv = map(.x = df , 
#                  .f = ~svyby(~MOV_PTV_e1, by=~TIPORESIDENCIA+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                 
#                 mutate(vacuna = MOV_PTV_e1,vacunatipo = "PTV_COMPLETA") %>% 
#                 select(-`se.as.numeric(MOV_PTV_e1)`,-MOV_PTV_e1) %>% data.frame),
#     
#     neumo = map(.x = df , 
#                  .f = ~svyby(~MOV_NEUMO_e1, by=~TIPORESIDENCIA+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_NEUMO_e1,vacunatipo = "NEUMO_COMPLETA") %>% 
#                   select(-`se.as.numeric(MOV_NEUMO_e1)`,-MOV_NEUMO_e1) %>% data.frame),
#     
#     influ = map(.x = df , 
#                  .f = ~svyby(~MOV_INFLU_e1, by=~TIPORESIDENCIA+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                   
#                   mutate(vacuna = MOV_INFLU_e1,vacunatipo = "INFLU_COMPLETA") %>%
#                   select(-`se.as.numeric(MOV_INFLU_e1)`,-MOV_INFLU_e1) %>% data.frame),
#     
#     rota = map(.x = df , 
#                  .f = ~svyby(~MOV_ROTA_e1, by=~TIPORESIDENCIA+DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
#                  
#                  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>%
#                  select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1) %>% data.frame) ) %>%
#   
#   select(-data) %>% 
#   
#   mutate(
#   
#   pretotal1  = map2(.x = ptv, .y = neumo, .f = ~bind_rows(.x,.y)),
#   pretotal2  = map2(.x = influ, .y = rota, .f = ~bind_rows(.x,.y)),
#   
#   total  = map2(.x = pretotal1, .y = pretotal2, .f = ~bind_rows(.x,.y)),
#   
# ) %>% 
#   
#   select(ANIO,total) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(total)) %>% 
#   
#   full_join(region_shape, by="DEPARTAMEN") %>% 
#   
#   mutate(ANIO = as.character(ANIO))
# 
# 
# 
# 
# ggplot(data = st_as_sf(df3) %>% mutate(vacuna = vacuna*100,
#                                        vacuna_cut = cut_interval(vacuna, n = 6))) +
#   
#   geom_sf(aes(fill = vacuna_cut)) +
#   
#   viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
#   
#   
#   facet_wrap(facets = ~TIPORESIDENCIA+ANIO) +
#   
#   theme_bw()

```

# EDUCACION DE LA MADRE

```{r, echo=F, warning=F, message=F, error=F}
# PTV<-svyby(~MOV_PTV_e1_2, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) 
# 
# 
# 
# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = EDU_MADRE)) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   theme_bw()


```

# INDICE DE RIQUEZA

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 15}
# PTV<-svyby(~MOV_PTV_e1_2, by=~INDICERIQUEZA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~INDICERIQUEZA +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~INDICERIQUEZA +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) %>% full_join(region_shape, by = c("DEPARTAMEN"))
# 
# 
# 
# # ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = INDICERIQUEZA)) +
# #   
# #   geom_col( position = position_dodge(width = 1), width = 0.8) +
# #   
# #   geom_errorbar(aes(ymin = ci_l, 
# #                     ymax = ci_u), 
# #                 
# #                 position = position_dodge(width = 1), 
# #                 
# #                 width = 0.25) +
# #   
# #   
# #   scale_fill_brewer(palette = 9) +
# #   
# #   theme_bw()
# 
# 
# 
# ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
#                                        vacuna_cut = cut_interval(vacuna, n = 6))) +
#   
#   geom_sf(aes(fill = vacuna_cut)) +
#   
#   viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
#   
#   
#   facet_wrap(facets = ~INDICERIQUEZA + vacunatipo, nrow = 5) +
#   
#   theme_bw()


```

# ETINIA MADRE

```{r, echo=F, warning=F, message=F, error=F}
# PTV<-svyby(~MOV_PTV_e1_2, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) 
# 
# mycolors <- colorRampPalette(brewer.pal(1, "Set2"))(12)
# 
# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = as.factor(ETNIA_MADRE))) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_manual(values = mycolors) + 
#   
#   theme_bw() +
#   
#   
#   coord_flip()

```

# EDUCACION MADRE

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 15}
# PTV<-svyby(~MOV_PTV_e1_2, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDU_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDU_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~EDU_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) %>% full_join(region_shape, by = c("DEPARTAMEN"))
# 
# 
# 
# # ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = as.factor(EDU_MADRE))) +
# #   
# #   geom_col( position = position_dodge(width = 1), width = 0.8) +
# #   
# #   geom_errorbar(aes(ymin = ci_l, 
# #                     ymax = ci_u), 
# #                 
# #                 position = position_dodge(width = 1), 
# #                 
# #                 width = 0.25) +
# #   
# #   
# #   scale_fill_brewer(palette = 9) +
# #   
# #   theme_bw()
# 
# 
# ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
#                                        vacuna_cut = cut_interval(vacuna, n = 6))) +
#   
#   geom_sf(aes(fill = vacuna_cut)) +
#   
#   viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
#   
#   
#   facet_wrap(facets = ~EDU_MADRE + vacunatipo, nrow = 2) +
#   
#   theme_bw()
# 

#MOV2020_2 %>% filter(DEPARTAMEN == "PUNO" & MOV_ROTA_e1 == 1 & EDU_MADRE == "sin educ")

```

# EDAD MADRE

```{r, echo=F, warning=F, message=F, error=F, fig.width= 10, fig.height= 10}
# PTV<-svyby(~MOV_PTV_e1_2, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)
# 
# 
# NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)
# 
# 
# INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 
# 
# 
# ROTA<-svyby(~MOV_ROTA_e1, by=~EDAD_MADRE +DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
#   
#   mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
#   
#   select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)
# 
# 
# 
# df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) %>% full_join(region_shape, by = c("DEPARTAMEN"))
# 
# 
# ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
#                                        vacuna_cut = cut_interval(vacuna, n = 6))) +
#   
#   geom_sf(aes(fill = vacuna_cut)) +
#   
#   viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
#   
#   
#   facet_wrap(facets = ~EDAD_MADRE + vacunatipo, nrow = 2) +
#   
#   theme_bw()
```


#DOSIS 11 ANIOS

Primeras Dosis de las 4 vacunas en los 11 anios de estudio.

```{r}
ptv1<-
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45PV1_1, design =.x, na.rm = T)),
    
    ptv1=map(.x = df,
             .f =~svyciprop(~S45PV1_1, design =.x, na.rm = T)),
    
     ptv1ci = map(.x = ptv1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(ptv1ci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "ptv1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)
  
  
influ1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45IF1_1, design =.x, na.rm = T)),
    
    influ1=map(.x = df,
             .f =~svyciprop(~S45IF1_1, design =.x, na.rm = T)),
    
     influci = map(.x = influ1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(influci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "influ1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)
  

neumo1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45NM1_1, design =.x, na.rm = T)),
    
    nuemo1=map(.x = df,
             .f =~svyciprop(~S45NM1_1, design =.x, na.rm = T)),
    
     neumoci = map(.x = nuemo1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(neumoci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "neumo1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



rota1<-  
  df2 %>%
  mutate(
    
    vacuna=map_dbl(.x = df,
             .f =~svymean(~S45RT1_1, design =.x, na.rm = T)),
    
    rota1=map(.x = df,
             .f =~svyciprop(~S45RT1_1, design =.x, na.rm = T)),
    
     rotaci = map(.x = rota1,
                 .f = ~confint(.x) %>% 
                   as.data.frame() %>%
                   rownames_to_column("tar"))) %>% 
  unnest(cols = c(rotaci)) %>% 
  as.data.frame() %>% 
  mutate(ci_l = `2.5%`,
         ci_h = `97.5%`,
         vacunatipo = "rota1") %>% 
  select(ANIO,ci_l,ci_h,vacunatipo,vacuna)



rbind(ptv1,neumo1,influ1,rota1) %>% 
  #ungroup() %>% 
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, 
             ymin = ci_l*100, ymax = ci_h*100, 
             fill= vacunatipo, col = vacunatipo, group = vacunatipo))+
  
  geom_smooth(alpha = 0.3, size = 1.2) +
  scale_fill_manual(values = c("#595260","#7ECA9C","#A98B98","#AD6C80"),
                     labels = c("INFLU1","NM1","PTV1","ROTA1")) +
  
  scale_color_manual(values = c("#595260","#7ECA9C","#A98B98","#AD6C80"),
                     labels = c("INFLU1","NM1","PTV1","ROTA1")) +
  
  xlab("Years") +
  scale_x_discrete(expand = c(0, 0.15))+
  ylab("Prop. %")+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold")
  ) 
             
ggsave("1raDosisTotal.png",width = 8, height = 6)           



```


# REGION / DOSIS

Dosis completas para las 4 vacunas en los 11 anios de estudio, por region.

```{r}
covertura.region<-
  df2 %>%
  mutate(
    
    ptv1=map(.x = df,
        .f =~svyby(~S45PV1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
          mutate(vacuna = S45PV1_1,vacunatipo = "PTV") %>%
          select(-`se.as.numeric(S45PV1_1)`,-S45PV1_1)),
    
    ptv2=map(.x = df,
             .f =~svyby(~S45PV2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45PV2_1,vacunatipo = "PTV") %>%
               select(-`se.as.numeric(S45PV2_1)`,-S45PV2_1)),
    
    ptv3=map(.x = df,
             .f =~svyby(~S45PV3_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45PV3_1,vacunatipo = "PTV") %>%
               select(-`se.as.numeric(S45PV3_1)`,-S45PV3_1)),
    
    
    neumo1=map(.x = df,
             .f =~svyby(~S45NM1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM1_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM1_1)`,-S45NM1_1)),
    
    neumo2=map(.x = df,
             .f =~svyby(~S45NM2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM2_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM2_1)`,-S45NM2_1)),
    
    neumo3=map(.x = df,
             .f =~svyby(~S45NM3_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45NM3_1,vacunatipo = "NEUMO") %>%
               select(-`se.as.numeric(S45NM3_1)`,-S45NM3_1)),
    
    
    
    influ1=map(.x = df,
             .f =~svyby(~S45IF1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45IF1_1,vacunatipo = "INFLU") %>%
               select(-`se.as.numeric(S45IF1_1)`,-S45IF1_1)),
    
    influ2=map(.x = df,
             .f =~svyby(~S45IF2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45IF2_1,vacunatipo = "INFLU") %>%
               select(-`se.as.numeric(S45IF2_1)`,-S45IF2_1)),
    
    
    
    
    rota1=map(.x = df,
             .f =~svyby(~S45RT1_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45RT1_1,vacunatipo = "ROTA") %>%
               select(-`se.as.numeric(S45RT1_1)`,-S45RT1_1)),
    
    rota2=map(.x = df,
             .f =~svyby(~S45RT2_1, by=~DEPARTAMEN, design =.x, FUN=svyciprop, vartype=c('se','ci')) %>%
               mutate(vacuna = S45RT2_1,vacunatipo = "ROTA") %>%
               select(-`se.as.numeric(S45RT2_1)`,-S45RT2_1)),
    
  
    )

```

## Graficos 

```{r}
covertura.region %>%
  pivot_longer(cols = c(ptv1:ptv3), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C","#A98B98"), 
                     labels = c("1º dose","2º dose","3º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN) 

ggsave("ptv_regiones.png", width = 18, height = 10)

covertura.region %>%
  pivot_longer(cols = c(neumo1:neumo3), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C","#A98B98"), 
                     labels = c("1º dose","2º dose","3º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

ggsave("neumo_regiones.png", width = 18, height = 10)


covertura.region %>%
  pivot_longer(cols = c(influ1:influ2), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C"), 
                     labels = c("1º dose","2º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

ggsave("influ_regiones.png", width = 18, height = 10)


covertura.region %>%
  pivot_longer(cols = c(rota1:rota2), names_to = "INDEX") %>% 
  unnest(cols = c(value)) %>% 
  
  ggplot(aes(x = as.factor(ANIO), y = vacuna*100, col = INDEX, group = INDEX))+
  geom_point() + 
  geom_line(size = 1.2)+
  scale_color_manual(values = c("#595260","#7ECA9C"), 
                     labels = c("1º dose","2º dose"))+
  
  geom_hline(aes(yintercept = 85), linetype = "dashed") + 
  #theme_minimal() +
  xlab("Years")+
  ylab("Prop. %")+
  labs(color = "")+
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 30, size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 9)
  )  +
  facet_wrap(~DEPARTAMEN)

ggsave("rota_regiones.png", width = 18, height = 10)
```

