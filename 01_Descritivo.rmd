---
title: "MOV 1"
author: "jose"
date: "18/6/2021"
output:
  html_document:
    code_folding: hide
    fig_height: 6
    fig_width: 9
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

# Bases
```{r, echo=F, warning=F, message=F, error=F}
library(tidyverse)
library(gtsummary)
library(survey)
library(RColorBrewer)
library(sf)

NINIO <- read.csv("ENDES/DIT.csv", sep = ";" )
NINIO2 <- read.csv("ENDES/REC41.csv", sep = ";" )
MUJER1 <- read.csv("ENDES/REC42.csv", sep = ";" )
VACUNA1 <- read.csv("ENDES/REC43.csv", sep = ";" )
VACUNA2 <- read.csv("ENDES/REC95.csv", sep = ";" )
HOGAR1 <- read.csv("ENDES/RECH0.csv", sep = ";" )
HOGAR_MADRE <- read.csv("ENDES/RECH1.csv", sep = ";" )
VIVIENDA1 <- read.csv("ENDES/RECH23.csv", sep = ";" )
MUJER2<- read.csv("ENDES/REC0111.csv", sep = ";" )
NINIO_ANEMIA<- read.csv("ENDES/RECH6.csv", sep = ";" )
region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")



```

# PRE UNION
```{r, warning=F, message=F, error=F}
# BD principales

## HHID Y HIDX son las variables de union 

VACUNA1 <- VACUNA1 %>% select(CASEID,HIDX,H1:H10) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))

VACUNA2 <- VACUNA2 %>% select(CASEID,IDX95,S466,S466B,S45D4:S45IF2Y) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)),
         
         HIDX = IDX95) 


# Otras BD


## HHID Y HIDX son las variables de union 

NINIO <- NINIO %>% select(CASEID,QI478,BIDX,BORD) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)),
         
         HIDX = BIDX) 


NINIO2 <- NINIO2 %>% select(CASEID,MIDX,M15) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)),
         
         HIDX = MIDX) 



MUJER1<- MUJER1 %>% select(CASEID,V481:V481X) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))



MUJER2<-MUJER2 %>% select(CASEID,V001,V002,V005,V012,V022,V023,V024,V025,V101,V102,V106,V131,V190) %>% 
  
  mutate(HHID = as.numeric(str_sub(CASEID,1,-3)))



HOGAR_MADRE<-HOGAR_MADRE %>% select(HHID,HVIDX,QH25A,HV122) %>% 
  
  mutate(HIDX = HVIDX)

# NINIO_ANEMIA <- NINIO_ANEMIA %>% select(HHID,HC0,HC1)

# Caracteristicas por Hogar

HOGAR1<- HOGAR1 %>% select(HHID,HV003,HV000:HV002A,HV005,HV022,HV007,HV008,HV021,HV023:HV026) 
VIVIENDA1<- VIVIENDA1 %>% select(HHID,HV270)
#


```

# UNION

```{r, warning=F, message=F, error=F}

## BD intermedias
VACUNA_2020 <- VACUNA1 %>% full_join(VACUNA2, by =c("HHID","HIDX","CASEID")) # Union tomando CASEID para no perder casos

NINIO_2020 <- NINIO %>% left_join(NINIO2, by = c("HHID","HIDX","CASEID"))



MUJER_2021 <- MUJER1 %>% 
  
  left_join(MUJER2, by = c("HHID","CASEID")) %>% 
  mutate(HIDX = as.numeric(str_sub(CASEID,-2,-1))) %>% 
  
  left_join(HOGAR_MADRE, by = c("HHID","HIDX"))


## BD final
MOV2020<- VACUNA_2020 %>% 
  
  left_join(NINIO_2020, by = c("HHID","HIDX","CASEID")) %>% 
  
  left_join(MUJER_2021, by = c("HHID","CASEID")) %>% 
  
  # FILTRO DE LOS NA POR EDAD
  filter(!is.na(QI478))

```

# EDITADO

```{r,warning=F, message=F, error=F}
prep.data <-function(MOV2020){ MOV2020 %>%
  
  select(CASEID,
         # H1,H2,H3,H4,H5,H6,H7,H8,H9,H10,
         # S45D4,S45D5,S45P4,S45P5,S45B0,S45B1,
         # S45B2,S45B3,S45TT,S45SP1,S45SP2,S45SR,
         S45F1,S45F2,S45F3,
         S45PV1,S45PV2,S45PV3,
         S45NM1,S45NM2,S45NM3,
         S45RT1,S45RT2,
         S45IF1,S45IF2,
         
         S466,S466B,V001,V005,V012,V022,V023,
         V024,V025,V102,V106,V131,
         QI478,V481:V481X,V190,V022) %>% 
  
  
  
  
        # cATEGORIAS DE RESPUESTA A LA VACUNACION
  mutate(
    
        across(S45F1:S45IF2,~ifelse(.x == 0|.x == 8,0, # 0: No, 8: No sabe
                                 ifelse(.x == 1|.x == 3,1,2))),# 1: Tarjeta fecha, # 3: Marca tarjeta

    
    
         
         CRED = as.factor(ifelse(S466==0 | S466 == 8,"No","Si")),
         
         
         CREDLUGAR = factor(S466B, levels = c(21,22,23,24,
                                              25,26,27,31,
                                              32,41,42,96), labels = c("H.MINSA/FFAA","H.ESSALUD","H.MINSA/FFAA",
                                                                 "CS/POSTA MINSA","CS/POSTA MINSA","CS.ESSALUD",
                                                                 "OTRO/PRIVADO","OTRO/PRIVADO","OTRO/PRIVADO","OTRO/PRIVADO",
                                                                 "OTRO/PRIVADO","OTRO/PRIVADO")),
         
         
         
         TIPORESIDENCIA = ifelse(V102==1,"URBANO","RURAL"),
         
         
         
         
         
         DEPARTAMEN = factor(V024, levels = c(1:25), labels = c("AMAZONAS","ANCASH","APURIMAC","AREQUIPA","AYACUCHO",
                                                            "CAJAMARCA","CALLAO","CUSCO","HUANCAVELICA","HUANUCO",
                                                            "ICA","JUNIN","LA LIBERTAD","LAMBAYEQUE","LIMA",
                                                            "LORETO","MADRE DE DIOS","MOQUEGUA","PASCO","PIURA",
                                                            "PUNO","SAN MARTIN","TACNA","TUMBES","UCAYALI")),
         
         
         
         EDU_MADRE = factor(V106, levels = c(0,1,2,3), labels = c("Sin educ","primaria","secundaria","superior")),
         
         
         ETNIA_MADRE = factor(V131, levels = c(1:12), labels = c("quechua","aimara","ashaninka","awajun",
                                                                 "shipibo","shawi","matsigenka","achuar",
                                                                 "Otro","castellano","portugues","Otro extranjero")),
         
         
         
         EDAD_ANIOS = round((QI478/12),0),
         
         SEGURO = factor(V481, levels = c(0,1), labels = c("No","Si")),
         
         EDAD_MADRE = ifelse(V012<18,"< 18 a",
                             ifelse(V012>=18&V012<35,"18-35 a",">35 a")),
         
         INDICERIQUEZA = V190,
    
    
        V005 = V005/1000000) %>% 
  
  
  fastDummies::dummy_cols(select_columns = c("S45F1","S45F2","S45F3", # Hib
                                             "S45PV1","S45PV2","S45PV3", #Pentavalente
                                             "S45NM1","S45NM2","S45NM3", #Neumococo
                                             "S45IF1","S45IF2", #Influenza
                                             "S45RT1","S45RT2" # Rotavirus
                                             
                                             )) %>% 
  
   # CON CRED O SEGURO
   filter((CRED == "Si" | SEGURO == "Si")) %>% 
  
  
  
  mutate( HIB_COMPLETA = as.factor(ifelse(S45F1 !=0 & S45F2 != 0 & S45F3 != 0,1,0)), # VACUNAS COMPLETAS
          PTV_COMPLETA = as.factor(ifelse(S45PV1 !=0 & S45PV2 != 0 & S45PV3 != 0,1,0)),
          NEUMO_COMPLETA = as.factor(ifelse(S45NM1 !=0 & S45NM2 != 0 & S45NM3 != 0,1,0)),
          INFLU_COMPLETA = as.factor(ifelse(S45IF1 !=0 & S45IF2 != 0,1,0)),
          ROTA_COMPLETA = as.factor(ifelse(S45RT1 !=0 & S45RT2 != 0,1,0)),
          
          
          # Inicio de esquemas 
          ## Pentavalente
          MOV_PTV_e1 = ifelse(QI478<12 & S45PV1==0,1,0),
          MOV_PTV_e2 = ifelse(QI478>12 & S45PV1==0,1,0),
          MOV_PTV_e1_2= ifelse(MOV_PTV_e1 ==1 | MOV_PTV_e2 == 1,1,0),
          
          ## Neumococo 
          MOV_NEUMO_e1 = ifelse(QI478<12 & S45NM1==0,1,0),
          MOV_NEUMO_e2 = ifelse(QI478>12 & S45NM1==0,1,0),
          MOV_NEUMO_e1_2 = ifelse(MOV_NEUMO_e1==1 | MOV_NEUMO_e2==1,1,0),
          
          ## Rotavirus (entre 2 y 4 meses, maximo 7 meses la 2da dosis)
          MOV_ROTA_e1 = ifelse(QI478>8 & S45RT2 == 0,1,0),
          
          ## INFLUENZA (<12 m : 2 dosis, 12-35 meses:1 dosis, >36 meses: 1 dosis adulto)
          
          MOV_INFLU_e1 = ifelse(QI478<12 & S45NM2 == 0,1,0),
          MOV_INFLU_e2 = ifelse(QI478>12 & S45NM1 == 0,1,0),
          MOV_INFLU_e1_2 = ifelse(MOV_INFLU_e1 == 1 | MOV_INFLU_e2==1, 1,0))
          
}


# Datos listos
MOV_2020_2<- prep.data(MOV2020)
```

# RESUMEN 

V001 : CONGLOMERADO
V022 : ESTRATO
V005 : FACTOR DE PONDERACION MUJER

```{r,warning=F, message=F, error=F}
df <- svydesign(id =~ V001, strata =~ V022, weights=~V005, data=MOV2020_2) 


options(survey.lonely.psu="remove")
# options(survey.adjust.domain.lonely=TRUE)
# options(survey.lonely.psu="adjust")

```

# PROPORCIONES POR REGIONES (GRAFICO)

```{r, echo=F, warning=F, message=F, error=F, fig.height= 10, fig.width= 10}



PTV_COMPLETA<-svyby(~MOV_PTV_e1_2, by=~DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(MOV_PTV_e1_2)`,-MOV_PTV_e1_2)


NEUMO_COMPLETA<-svyby(~MOV_NEUMO_e1_2, by=~DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(MOV_NEUMO_e1_2)`,-MOV_NEUMO_e1_2)


INFLU_COMPLETA<-svyby(~MOV_INFLU_e1_2, by=~DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(MOV_INFLU_e1_2)`,-MOV_INFLU_e1_2) 


ROTA_COMPLETA<-svyby(~MOV_ROTA_e1, by=~DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(MOV_ROTA_e1)`,-MOV_ROTA_e1)



df2 <- bind_rows(PTV_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA) %>% full_join(region_shape, by = c("DEPARTAMEN"))



grafico.region<- function(df2) { ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +
  
  geom_sf(aes(fill = vacuna)) +
  
  viridis::scale_fill_viridis(option = "A", direction = 1)  + 
  
  
  facet_wrap(facets = ~vacunatipo)
  
  }


grafico.region(df2)



```


# PROPORCION POR CRED 

```{r, echo=F, warning=F, message=F, error=F}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~CRED, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~CRED, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~CRED, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~CRED, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~CRED, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA)



ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = CRED)) +
  
  geom_col( position = position_dodge(width = 1), width = 0.8) +
  
  geom_errorbar(aes(ymin = ci_l, 
                    ymax = ci_u), 
                
                position = position_dodge(width = 1), 
                
                width = 0.25) +
  
  
  scale_fill_brewer(palette = 9) +
  
  theme_bw()
```

# PROPORCION POR LUGAR DONDE TIENE CRED

```{r, echo=F, warning=F, message=F, error=F}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~CREDLUGAR, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~CREDLUGAR, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~CREDLUGAR, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~CREDLUGAR, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~CREDLUGAR, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA)

ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = CREDLUGAR)) +
  
  geom_col( position = position_dodge(width = 1), width = 0.8) +
  
  geom_errorbar(aes(ymin = ci_l, 
                    ymax = ci_u), 
                
                position = position_dodge(width = 1), 
                
                width = 0.25) +
  
  
  scale_fill_brewer(palette = 9) +
  
  theme_bw()

```

# TIPO DE RESIDENCIA 

```{r, echo=F, warning=F, message=F, error=F}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~TIPORESIDENCIA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~TIPORESIDENCIA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~TIPORESIDENCIA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~TIPORESIDENCIA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~TIPORESIDENCIA + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA) %>%  full_join(region_shape, by = c("DEPARTAMEN"))



# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = TIPORESIDENCIA)) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   theme_bw()



ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +
  
  geom_sf(aes(fill = vacuna_cut)) +
  
  viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
  
  
  facet_wrap(facets = ~TIPORESIDENCIA + vacunatipo, nrow = 2) +
  
  theme_bw()


```

# EDUCACION DE LA MADRE


```{r, echo=F, warning=F, message=F, error=F}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~EDU_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA)



ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = EDU_MADRE)) +
  
  geom_col( position = position_dodge(width = 1), width = 0.8) +
  
  geom_errorbar(aes(ymin = ci_l, 
                    ymax = ci_u), 
                
                position = position_dodge(width = 1), 
                
                width = 0.25) +
  
  
  scale_fill_brewer(palette = 9) +
  
  theme_bw()


```

# INDICE DE RIQUEZA

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 15}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~INDICERIQUEZA+DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~INDICERIQUEZA+DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~INDICERIQUEZA+DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~INDICERIQUEZA+DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~INDICERIQUEZA+DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA) %>%  full_join(region_shape, by = c("DEPARTAMEN"))



# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = INDICERIQUEZA)) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   theme_bw()



ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +
  
  geom_sf(aes(fill = vacuna_cut)) +
  
  viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
  
  
  facet_wrap(facets = ~INDICERIQUEZA + vacunatipo, nrow = 5) +
  
  theme_bw()


```

# ETINIA MADRE

```{r, echo=F, warning=F, message=F, error=F}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~ETNIA_MADRE, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA)

mycolors <- colorRampPalette(brewer.pal(1, "Set2"))(12)

ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = as.factor(ETNIA_MADRE))) +
  
  geom_col( position = position_dodge(width = 1), width = 0.8) +
  
  geom_errorbar(aes(ymin = ci_l, 
                    ymax = ci_u), 
                
                position = position_dodge(width = 1), 
                
                width = 0.25) +
  
  
  scale_fill_manual(values = mycolors) + 
  
  theme_bw() +
  
  
  coord_flip()

```

# EDUCACION MADRE

```{r, echo=F, warning=F, message=F, error=F, fig.width= 15, fig.height= 15}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~EDU_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA) %>% full_join(region_shape, by = c("DEPARTAMEN"))



# ggplot(data = df2, aes(x = vacunatipo, y = vacuna, fill = as.factor(EDU_MADRE))) +
#   
#   geom_col( position = position_dodge(width = 1), width = 0.8) +
#   
#   geom_errorbar(aes(ymin = ci_l, 
#                     ymax = ci_u), 
#                 
#                 position = position_dodge(width = 1), 
#                 
#                 width = 0.25) +
#   
#   
#   scale_fill_brewer(palette = 9) +
#   
#   theme_bw()


ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +
  
  geom_sf(aes(fill = vacuna_cut)) +
  
  viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
  
  
  facet_wrap(facets = ~EDU_MADRE + vacunatipo, nrow = 2) +
  
  theme_bw()
```


# EDAD MADRE
```{r, echo=F, warning=F, message=F, error=F, fig.width= 10, fig.height= 10}
PTV_COMPLETA<-svyby(~PTV_COMPLETA, by=~EDAD_MADRE + DEPARTAMEN,design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = PTV_COMPLETA,vacunatipo = "PTV_COMPLETA") %>% 
  
  select(-`se.as.numeric(PTV_COMPLETA)`,-PTV_COMPLETA)


HIB_COMPLETA<-svyby(~HIB_COMPLETA, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = HIB_COMPLETA,vacunatipo = "HIB_COMPLETA") %>% 
  
  select(-`se.as.numeric(HIB_COMPLETA)`,-HIB_COMPLETA)


NEUMO_COMPLETA<-svyby(~NEUMO_COMPLETA, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = NEUMO_COMPLETA,vacunatipo = "NEUMO_COMPLETA") %>% 
  
  select(-`se.as.numeric(NEUMO_COMPLETA)`,-NEUMO_COMPLETA)


INFLU_COMPLETA<-svyby(~INFLU_COMPLETA, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = INFLU_COMPLETA,vacunatipo = "INFLU_COMPLETA") %>% 
  
  select(-`se.as.numeric(INFLU_COMPLETA)`,-INFLU_COMPLETA)


ROTA_COMPLETA<-svyby(~ROTA_COMPLETA, by=~EDAD_MADRE + DEPARTAMEN, design =df, FUN=svyciprop, vartype=c('se','ci')) %>% 
  
  mutate(vacuna = ROTA_COMPLETA,vacunatipo = "ROTA_COMPLETA") %>% 
  
  select(-`se.as.numeric(ROTA_COMPLETA)`,-ROTA_COMPLETA)



df2 <- bind_rows(PTV_COMPLETA,HIB_COMPLETA,NEUMO_COMPLETA,INFLU_COMPLETA,ROTA_COMPLETA) %>% full_join(region_shape, by = c("DEPARTAMEN"))


ggplot(data = st_as_sf(df2) %>% mutate(vacuna = vacuna*100,
                                       vacuna_cut = cut_interval(vacuna, n = 6))) +
  
  geom_sf(aes(fill = vacuna_cut)) +
  
  viridis::scale_fill_viridis(option = "D", direction = 1, discrete = T)  + 
  
  
  facet_wrap(facets = ~EDAD_MADRE + vacunatipo, nrow = 2) +
  
  theme_bw()
```


# TBL_SVYSUMMARY

```{r}
df %>% gtsummary::tbl_svysummary(include = c(HIB_COMPLETA:ROTA_COMPLETA))
```


