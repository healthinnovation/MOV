---
title: "Untitled"
output: html_document
---

```{r, warning=F, message=F,comment=F}

library(tidyverse)
library(survey)
library(jtools)
library(sandwich)
library(sf)
```

```{r}
# Base de trabajo
MOV2020_2 <- read.csv("./BD.INTERMEDIAS/MOV2020_2.csv")
region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")

#BD en survey
df <- svydesign(id =~ V001, strata =~ V022, probs=~V005, data=MOV2020_2) 


options(survey.lonely.psu="remove")
```

# EVENTO

## DEPARTAMENTOS

```{r}
# Total de casos del evento 

    
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)

# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  #full_join(total.dep, by = "DEPARTAMEN") %>% 
  
  arrange(casos.mov.ptv) %>% 
  
  #select(DEPARTAMEN,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)
         ) %>% 
  
  select(-pop,-popr,-pop.popr) %>% 
         filter(DEPARTAMEN != "MADRE DE DIOS") 

  
  


```

```{r}

# Grafico para verificar linealidad
ggplot(data = total.dep2 , aes(x =hr2 , y = casos.mov.ptv)) +
  
  geom_point() +
  
  geom_smooth(method = "lm")


ssi <- lm(casos.mov.ptv ~ hr2, data = total.dep2)

jtools::summ(ssi, confint = T, robust = T)

```

```{r}
bd <- data.frame(hr2 = c(0,1))

RRI<-predict(ssi,newdata = bd %>% filter(hr2 == 1))/predict(ssi,newdata = bd %>% filter(hr2 == 0))


depa.ssi<-c(Variable="DEPARTAMENTO",SSI=round(ssi$coefficients[2],1),RRI=round(RRI[1],2))
depa.ssi
```

## CRED LUGAR

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~CREDLUGAR, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  arrange(casos.mov.ptv) %>% 
  
  select(CREDLUGAR,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
         
  
  select(-pop,-popr,-pop.popr) %>% filter(CREDLUGAR != "NoCRED")




```

```{r}
# Grafico para verificar linealidad
ggplot(data = total.dep2, aes(x =hr2 , y = casos.mov.ptv)) +
  
  geom_point() +
  
  geom_smooth(method = "lm")


ssi <- lm(casos.mov.ptv ~ hr2, data = total.dep2)

jtools::summ(ssi, confint = T, robust = T)
```

```{r}
bd <- data.frame(hr2 = c(0,1))

RRI<-predict(ssi,newdata = bd %>% filter(hr2 == 1))/predict(ssi,newdata = bd %>% filter(hr2 == 0))


credtipo.ssi<-c(Variable="DEPARTAMENTO",SSI=round(ssi$coefficients[2],1),RRI=round(RRI[1],2))
credtipo.ssi


```

## EDUCACION DE LA MADRE

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~EDU_MADRE, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  arrange(casos.mov.ptv) %>% 
  
  select(EDU_MADRE,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
         
  
  select(-pop,-popr,-pop.popr)




```

```{r}
# Grafico para verificar linealidad
ggplot(data = total.dep2, aes(x = casos.mov.ptv, y = hr2)) +
  
  geom_point() +
  
  geom_smooth(method = "lm")


ssi <- lm(casos.mov.ptv ~ hr2, data = total.dep2)

jtools::summ(ssi, confint = T, robust = T)
```

```{r}
bd <- data.frame(hr2 = c(0,1))

RRI<-predict(ssi,newdata = bd %>% filter(hr2 == 1))/predict(ssi,newdata = bd %>% filter(hr2 == 0))


edumadre.ssi<-c(Variable="DEPARTAMENTO",SSI=round(ssi$coefficients[2],1),RRI=round(RRI[1],2))
edumadre.ssi


```

## INDICE RIQUEZA

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~INDICERIQUEZA, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  arrange(casos.mov.ptv) %>% 
  
  select(INDICERIQUEZA,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
         
  
  select(-pop,-popr,-pop.popr)




```

```{r}
# Grafico para verificar linealidad
ggplot(data = total.dep2, aes(x = casos.mov.ptv, y = hr2)) +
  
  geom_point() +
  
  geom_smooth(method = "lm")


ssi <- lm(casos.mov.ptv ~ hr2, data = total.dep2)

jtools::summ(ssi, confint = T, robust = T)
```

```{r}
bd <- data.frame(hr2 = c(0,1))

RRI<-predict(ssi,newdata = bd %>% filter(hr2 == 1))/predict(ssi,newdata = bd %>% filter(hr2 == 0))


riqueza.ssi<-c(Variable="DEPARTAMENTO",SSI=round(ssi$coefficients[2],1),RRI=round(RRI[1],2))
riqueza.ssi


```

## EDAD MADRE

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~EDAD_MADRE, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  arrange(casos.mov.ptv) %>% 
  
  select(EDAD_MADRE,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
         
  
  select(-pop,-popr,-pop.popr)




```

```{r}
# Grafico para verificar linealidad
ggplot(data = total.dep2, aes(x = casos.mov.ptv, y = hr2)) +
  
  geom_point() +
  
  geom_smooth(method = "lm")


ssi <- lm(casos.mov.ptv ~ hr2, data = total.dep2)

jtools::summ(ssi, confint = T, robust = T)
```

```{r}
bd <- data.frame(hr2 = c(0,1))

RRI<-predict(ssi,newdata = bd %>% filter(hr2 == 1))/predict(ssi,newdata = bd %>% filter(hr2 == 0))


edad.ssi<-c(Variable="DEPARTAMENTO",SSI=round(ssi$coefficients[2],1),RRI=round(RRI[1],2))
edad.ssi

```

# EVENTO POR REGION

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~INDICERIQUEZA + DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  group_by(INDICERIQUEZA) %>% 
  
  arrange(casos.mov.ptv, .by_group = T) %>% 
  
  select(INDICERIQUEZA,DEPARTAMEN,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
  
  ungroup() %>% 
         
  
  select(-pop,-popr,-pop.popr) %>% filter(DEPARTAMEN != "MADRE DE DIOS")




```


```{r}

# Grafico lm
ggplot(data = total.dep2 , aes(x =hr2 , y = casos.mov.ptv)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") + 
  
  facet_wrap(~INDICERIQUEZA)



# map

gg<-total.dep2 %>% 
  
  group_by(DEPARTAMEN) %>% 
  
  nest() %>% 
  
  mutate(
    
    modelo = map(.x = data, .f = ~lm(data = .x, formula = casos.mov.ptv~hr2)),
    
    modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T))
  
    ) %>% 
   
   unnest(cols = c(modelo2)) %>% 
   
   group_by(DEPARTAMEN) %>% 
   
   slice(2) %>% 
   
   select(DEPARTAMEN,term,estimate) %>% data.frame() %>% 
   
   left_join(region_shape, by = "DEPARTAMEN") %>% 
   
   st_as_sf() %>% 
   
   ggplot() +
   
   geom_sf(aes(fill = estimate)) + 
   
   theme_minimal() + 
   
   labs(fill = "SSI\nInd.Riqueza") + 
   
   scale_fill_viridis_c()
  
ggsave("gg.png",gg,height = 8,width = 8)
```

