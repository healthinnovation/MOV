---
title: "Untitled"
output: html_document
---

```{r, warning=F, message=F,comment=F}

library(tidyverse)
library(survey)
library(jtools)
library(sandwich)
library(sf)
```

```{r}
# Base de trabajo
MOV2020_2 <- read.csv("./BD.INTERMEDIAS/MOV2020_2.csv")
region_shape <- st_read("./ENDES/Regiones/DEPARTAMENTOS.shp")

#BD en survey
df <- svydesign(id =~ V001, strata =~ V022, probs=~V005, data=MOV2020_2) 


options(survey.lonely.psu="remove")
```

# EVENTO

## DEPARTAMENTOS

```{r}
PTV<-svyby(~MOV_PTV_e1_2, by=~DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV") %>% 
  
  select(-MOV_PTV_e1_2)


NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO") %>% 
  
  select(-MOV_NEUMO_e1_2)


INFLU<-svyby(~MOV_INFLU_e1_2, by=~DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU") %>% 
  
  select(-MOV_INFLU_e1_2) 


ROTA<-svyby(~MOV_ROTA_e1, by=~DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
  
  select(-MOV_ROTA_e1)



df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA) 



```

### Generando HR

```{r}
df2<-
  df2 %>% 
  group_by(vacunatipo) %>% 
  
  arrange(vacuna,.by_group = T) %>% 

  mutate(pop= vacuna/sum(vacuna),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)
         ) %>% 
  
  select(-pop,-popr,-pop.popr)

```

### Verificar

```{r}
ggplot(data = df2 , aes(x =hr2 , y = vacuna)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
```

### SII y RII por vacuna

```{r}

bd <- data.frame(hr2 = c(0,1))

df2<-
  df2 %>% 
  
  #filter(DEPARTAMEN != "MADRE DE DIOS") %>% 
  
  group_by(vacunatipo) %>% 
  
  nest() %>% 
  
  mutate(
    
    modelo = map(.x = data, .f = ~lm(formula = vacuna~hr2, data = .x)),
    
    modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T)),

    ) %>% 
  
  ungroup() %>% 
  
  unnest(cols = c(modelo2)) %>% 
  
  group_by(vacunatipo) %>% 
  
  slice(2) %>%
  
  mutate(rii = map_dbl(.x = modelo, 
                       .f =~predict(.x,newdata = bd %>% filter(hr2 == 1))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
         
         ssi = estimate) %>% 
  
  select(vacunatipo,term,ssi,rii)

df2

```

## CRED LUGAR

```{r}
PTV<-svyby(~MOV_PTV_e1_2, by=~CREDLUGAR, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV") %>% 
  
  select(-MOV_PTV_e1_2)


NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~CREDLUGAR, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO") %>% 
  
  select(-MOV_NEUMO_e1_2)


INFLU<-svyby(~MOV_INFLU_e1_2, by=~CREDLUGAR, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU") %>% 
  
  select(-MOV_INFLU_e1_2) 


ROTA<-svyby(~MOV_ROTA_e1, by=~CREDLUGAR, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
  
  select(-MOV_ROTA_e1)



df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA)

```

### Generando HR
```{r}
df2<-
  df2 %>% 
  group_by(vacunatipo) %>% 
  
  arrange(vacuna,.by_group = T) %>% 

  mutate(pop= vacuna/sum(vacuna),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)
         ) %>% 
  
  select(-pop,-popr,-pop.popr)
```

### Verificar
```{r}
ggplot(data = df2 , aes(x =hr2 , y = vacuna)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
```

### SII y RII por vacuna
```{r}
bd <- data.frame(hr2 = c(0,1))

df2<-
  df2 %>% 
  
  #filter(CREDLUGAR != "NoCRED") %>% 
  
  group_by(vacunatipo) %>% 
  
  nest() %>% 
  
  mutate(
    
    modelo = map(.x = data, .f = ~lm(formula = vacuna~hr2, data = .x)),
    
    modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T)),

    ) %>% 
  
  ungroup() %>% 
  
  unnest(cols = c(modelo2)) %>% 
  
  group_by(vacunatipo) %>% 
  
  slice(2) %>%
  
  mutate(rii = map_dbl(.x = modelo, 
                       .f =~predict(.x,newdata = bd %>% filter(hr2 == 1))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
         
         ssi = estimate) %>% 
  
  select(vacunatipo,term,ssi,rii)


```

## EDUCACION DE LA MADRE


```{r}
PTV<-svyby(~MOV_PTV_e1_2, by=~EDU_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV") %>% 
  
  select(-MOV_PTV_e1_2)


NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDU_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO") %>% 
  
  select(-MOV_NEUMO_e1_2)


INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDU_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU") %>% 
  
  select(-MOV_INFLU_e1_2) 


ROTA<-svyby(~MOV_ROTA_e1, by=~EDU_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
  
  select(-MOV_ROTA_e1)



df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA)

```

### Generando HR
```{r}
# df2<-
#   df2 %>% 
#   group_by(vacunatipo) %>% 
#   
#   arrange(vacuna,.by_group = T) %>% 
# 
#   mutate(pop= vacuna/sum(vacuna),
#          
#          popr = cumsum(pop)/sum(pop),
#          pop.popr = popr - pop,
#          hr2 = round((pop.popr + popr)/2,3)
#          ) %>% 
#   
#   select(-pop,-popr,-pop.popr)
```

### Verificar
```{r}
ggplot(data = df2 , aes(x =hr2 , y = vacuna)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
```

### SII y RII por vacuna
```{r}
# bd <- data.frame(hr2 = c(0,1))
# 
# df2<-
#   df2 %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   nest() %>% 
#   
#   mutate(
#     
#     modelo = map(.x = data, .f = ~lm(formula = vacuna~hr2, data = .x)),
#     
#     modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T)),
# 
#     ) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(modelo2)) %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   slice(2) %>%
#   
#   mutate(rii = map_dbl(.x = modelo, 
#                        .f =~predict(.x,newdata = bd %>% filter(hr2 == 1))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
#          
#          ssi = estimate) %>% 
#   
#   select(vacunatipo,term,ssi,rii)
# 
# df2

ssi_rri(df2)

```


## INDICE RIQUEZA

```{r}
PTV<-svyby(~MOV_PTV_e1_2, by=~INDICERIQUEZA, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV") %>% 
  
  select(-MOV_PTV_e1_2)


NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~INDICERIQUEZA, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO") %>% 
  
  select(-MOV_NEUMO_e1_2)


INFLU<-svyby(~MOV_INFLU_e1_2, by=~INDICERIQUEZA, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU") %>% 
  
  select(-MOV_INFLU_e1_2) 


ROTA<-svyby(~MOV_ROTA_e1, by=~INDICERIQUEZA, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
  
  select(-MOV_ROTA_e1)



df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA)




```

### Generando HR
```{r}
# df2<-
#   df2 %>% 
#   group_by(vacunatipo) %>% 
#   
#   arrange(vacuna,.by_group = T) %>% 
# 
#   mutate(pop= vacuna/sum(vacuna),
#          
#          popr = cumsum(pop)/sum(pop),
#          pop.popr = popr - pop,
#          hr2 = round((pop.popr + popr)/2,3)
#          ) %>% 
#   
#   select(-pop,-popr,-pop.popr)
```

### Verificar
```{r}
ggplot(data = df2 , aes(x =hr2 , y = vacuna)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
```

### SII y RII por vacuna
```{r}
# bd <- data.frame(hr2 = c(0,1))
# 
# df2<-
#   df2 %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   nest() %>% 
#   
#   mutate(
#     
#     modelo = map(.x = data, .f = ~lm(formula = vacuna~hr2, data = .x)),
#     
#     modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T)),
# 
#     ) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(modelo2)) %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   slice(2) %>%
#   
#   mutate(rii = map_dbl(.x = modelo, 
#                        .f =~predict(.x,newdata = bd %>% filter(hr2 == 1))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
#          
#          ssi = estimate) %>% 
#   
#   select(vacunatipo,term,ssi,rii)

ssi_rri(df2)
```


## EDAD MADRE

```{r}
PTV<-svyby(~MOV_PTV_e1_2, by=~EDAD_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_PTV_e1_2,vacunatipo = "PTV") %>% 
  
  select(-MOV_PTV_e1_2)


NEUMO<-svyby(~MOV_NEUMO_e1_2, by=~EDAD_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_NEUMO_e1_2,vacunatipo = "NEUMO") %>% 
  
  select(-MOV_NEUMO_e1_2)


INFLU<-svyby(~MOV_INFLU_e1_2, by=~EDAD_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_INFLU_e1_2,vacunatipo = "INFLU") %>% 
  
  select(-MOV_INFLU_e1_2) 


ROTA<-svyby(~MOV_ROTA_e1, by=~EDAD_MADRE, design =df, FUN=svytotal) %>% 
  
  mutate(vacuna = MOV_ROTA_e1,vacunatipo = "ROTA") %>% 
  
  select(-MOV_ROTA_e1)



df2 <- bind_rows(PTV,NEUMO,INFLU,ROTA)

```

### Generando HR
```{r}
# df2<-
#   df2 %>% 
#   group_by(vacunatipo) %>% 
#   
#   arrange(vacuna,.by_group = T) %>% 
# 
#   mutate(pop= vacuna/sum(vacuna),
#          
#          popr = cumsum(pop)/sum(pop),
#          pop.popr = popr - pop,
#          hr2 = round((pop.popr + popr)/2,3)
#          ) %>% 
#   
#   select(-pop,-popr,-pop.popr)
```

### Verificar
```{r}
ggplot(data = df2 , aes(x =hr2 , y = vacuna)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
```

### SII y RII por vacuna
```{r}
# bd <- data.frame(hr2 = c(0,1))
# 
# df2<-
#   df2 %>% 
#   
#   #filter(CREDLUGAR != "NoCRED") %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   nest() %>% 
#   
#   mutate(
#     
#     modelo = map(.x = data, .f = ~lm(formula = vacuna~hr2, data = .x)),
#     
#     modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T)),
# 
#     ) %>% 
#   
#   ungroup() %>% 
#   
#   unnest(cols = c(modelo2)) %>% 
#   
#   group_by(vacunatipo) %>% 
#   
#   slice(2) %>%
#   
#   mutate(rii = map_dbl(.x = modelo, 
#                        .f =~predict(.x,newdata = bd %>% filter(hr2 == 1))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
#          
#          ssi = estimate) %>% 
#   
#   select(vacunatipo,term,ssi,rii)
# 


ssi_rri(df2)
```

# EVENTO POR REGION

```{r}
total.casos<-
  svyby(~MOV_PTV_e1_2, by=~INDICERIQUEZA + DEPARTAMEN, design =df, FUN=svytotal) %>% 
  
  data.frame() %>%
  
  mutate(casos.mov.ptv= MOV_PTV_e1_2) %>% 
    
  select(-MOV_PTV_e1_2)



# Union de bases y calculo del HR
total.dep2<-
  total.casos %>% 
  
  group_by(INDICERIQUEZA) %>% 
  
  arrange(casos.mov.ptv, .by_group = T) %>% 
  
  select(INDICERIQUEZA,DEPARTAMEN,casos.mov.ptv) %>% 
  
  mutate(pop= casos.mov.ptv/sum(casos.mov.ptv),
         
         popr = cumsum(pop)/sum(pop),
         pop.popr = popr - pop,
         hr2 = round((pop.popr + popr)/2,3)) %>% 
  
  ungroup() %>% 
         
  
  select(-pop,-popr,-pop.popr) 
  
  #filter(DEPARTAMEN != "MADRE DE DIOS")




```

```{r}

# Grafico lm
ggplot(data = total.dep2 , aes(x =hr2 , y = casos.mov.ptv)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") + 
  
  facet_wrap(~DEPARTAMEN)



# map

gg<-total.dep2 %>% 
  
  group_by(DEPARTAMEN) %>% 
  
  nest() %>% 
  
  mutate(
    
    modelo = map(.x = data, .f = ~lm(data = .x, formula = casos.mov.ptv~hr2)),
    
    modelo2 = map(.x = modelo, .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, type = "HC2"), conf.int = T))
  
    ) %>% 
   
   unnest(cols = c(modelo2)) %>% 
   
   group_by(DEPARTAMEN) %>% 
   
   slice(2) %>% 
   
   select(DEPARTAMEN,term,estimate) %>% data.frame() %>% 
   
   left_join(region_shape, by = "DEPARTAMEN") %>% 
   
   st_as_sf() %>% 
   
   ggplot() +
   
   geom_sf(aes(fill = estimate)) + 
   
   theme_minimal() + 
   
   labs(fill = "SSI\nIR") + 
   
   scale_fill_viridis_c() 

gg
  
#ggsave("gg.png",gg,height = 8,width = 8)
```
