---
title: "ssi_rri function"
output: html_document
---

#1. SII_RII

```{r}
h_prop<-
   function(data) {
   
 data<-
    data %>% 
   group_by(vacunatipo) %>%  
    
    mutate(
       tasa = (vacuna/total)*10000
    ) %>% 
   
    # ordenar de - a +
   arrange(tasa,.by_group = T) %>% 
   
     # Calculo de hr
   mutate(pop= vacuna/sum(vacuna),
          #tasa = (vacuna/total)*10000,
          popr = cumsum(pop)/sum(pop),
          pop.popr = popr - pop,
          hr2 = round((pop.popr + popr)/2,3)*100
          ) %>% 
   
   select(-pop,-popr,-pop.popr)
 
 
 data 
}
```


```{r}
sii_rii<-function(data) {
   
   
   bd <- data.frame(hr2 = c(0,100))
 
 data<-
   data %>% 
   group_by(vacunatipo) %>%  
    
    mutate(
       tasa = (vacuna/total)*10000
    ) %>% 
   
    # ordenar de - a +
   arrange(tasa,.by_group = T) %>% 
   
     # Calculo de hr
   mutate(pop= vacuna/sum(vacuna),
          #tasa = (vacuna/total)*10000,
          popr = cumsum(pop)/sum(pop),
          pop.popr = popr - pop,
          hr2 = round((pop.popr + popr)/2,3)*100
          ) %>% 
   
   select(-pop,-popr,-pop.popr) %>% 
 
   
   group_by(vacunatipo) %>% 
   
   nest() %>% 
   
   mutate(
     
      # lm para ssi 
     modelo = map(.x = data, .f = ~lm(formula = tasa~hr2, data = .x)),
     
      # extraer beta
     modelo2 = map(.x = modelo, 
                   .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, 
                                               type = "HC2"), conf.int = T)),
 
     ) %>% 
   
   ungroup() %>% 
   
   unnest(cols = c(modelo2)) %>% 
   
   group_by(vacunatipo) %>% 
   
   slice(2) %>%
   
    # rri f(1)/f(0)
   mutate(rii = map_dbl(.x = modelo,
                .f =~predict(.x,
                             newdata = bd %>% filter(hr2 == 100))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
          
          ssi = estimate) %>% 
   
   select(vacunatipo,term,ssi,rii)
 
 data
 
}

```




#2. SII_RII MAPAS

```{r}
h_prop.map <-
   function(data) {

   data<-
      data %>% 
   group_by(DEPARTAMEN,vacunatipo) %>% 
      mutate(
         tasa = (vacuna/total)*10000 
      ) %>% 
   
    # ordenar de - a +
   arrange(tasa,.by_group = T) %>% 
   
     # Calculo de hr
   mutate(pop= vacuna/sum(vacuna),
          
          popr = cumsum(pop)/sum(pop),
          pop.popr = popr - pop,
          hr2 = round((pop.popr + popr)/2,3)
          ) %>% 
   
   select(-pop,-popr,-pop.popr) %>% 
 
   
   group_by(DEPARTAMEN,vacunatipo) 
   
   data
   
}
```


```{r}

sii_rii_map<-function(data) {
   
   
   bd <- data.frame(hr2 = c(0,100))
 

   data<-
      data %>% 
      
   group_by(DEPARTAMEN,vacunatipo) %>% 
      
      mutate(
         tasa = (vacuna/total)*10000
      ) %>% 
   
    # ordenar de - a +
   arrange(tasa,.by_group = T) %>% 
   
     # Calculo de hr
   mutate(pop= vacuna/sum(vacuna),
          
          popr = cumsum(pop)/sum(pop),
          pop.popr = popr - pop,
          hr2 = round((pop.popr + popr)/2,3)
          ) %>% 
   
   select(-pop,-popr,-pop.popr) %>% 
 
   
   group_by(DEPARTAMEN,vacunatipo) %>% 
   
   nest() %>% 
   
   mutate(
     
      # lm para ssi 
     modelo = map(.x = data, .f = ~lm(formula = tasa~hr2, data = .x)),
     
      # extraer beta
     modelo2 = map(.x = modelo, 
                   .f = ~tidy(lmtest::coeftest(.x, vcov = vcovHC, 
                                               type = "HC2"), conf.int = T)),
 
     ) %>% 
   
   #ungroup() %>% 
   
   unnest(cols = c(modelo2)) %>% 
   
   slice(2) %>%
   
    # rri f(1)/f(0)
   mutate(rii = map_dbl(.x = modelo,
                        .f =~predict(.x,
                                     newdata = bd %>% filter(hr2 == 100))/predict(.x,newdata = bd %>% filter(hr2 == 0))),
          
          sii = estimate) %>% 
      
      mutate(sii = round(sii,2),
             rii = round(rii,1)) %>% 
   
   select(vacunatipo,term,sii,rii)
 
 data
 
}
```

# grafico de verificaci√≥n

```{r}
gg<-function(df2){ ggplot(data = df2 , aes(x =hr2 , y = tasa)) +
  
  geom_point() +
  
  geom_smooth(method = "lm") +
  
  facet_wrap(~vacunatipo)
   
}
```
